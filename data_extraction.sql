--latest version

--FIRST THING: CALCULATE AGE OF PATIENT FOR EACH ICUSTAY_ID
SELECT I.ICUSTAY_ID, I.HADM_ID, P.GENDER, P.EXPIRE_FLAG as DEAD, I.INTIME, I.OUTTIME, (INTIME::date - DOB::date)/365 as AGE
INTO ICUSTAYS_PAT 
FROM MIMIC_UNTOUCHED.ICUSTAYS I  INNER JOIN  MIMIC_UNTOUCHED.PATIENTS P  on I.SUBJECT_ID = P.SUBJECT_ID 
WHERE P.DOB < I.INTIME 
    and I.ICUSTAY_ID IS NOT NULL 
    AND (I.INTIME::date - P.DOB::date)/365 BETWEEN 14 and 89
--GROUP BY I.ICUSTAY_ID, I.HADM_ID, P.GENDER, P.EXPIRE_FLAG,I.INTIME, I.OUTTIME,P.DOB
ORDER BY I.ICUSTAY_ID;
--50711 


--WEIGHTS X ICUSTAY_ID
DROP TABLE IF EXISTS WEIGHTS;
SELECT I.ICUSTAY_ID, AVG(C.VALUENUM) AS AVG_WEIGHT
INTO WEIGHTS
FROM MIMIC_UNTOUCHED.CHARTEVENTS C JOIN ICUSTAYS_PAT I ON  C.ICUSTAY_ID = I.ICUSTAY_ID
WHERE  I.AGE BETWEEN 14 AND 89 --IN PIU'
	AND C.VALUENUM IS NOT NULL
	AND C.VALUENUM > 0 
	AND	C.ITEMID IN (224639,3693,763,581,580) 
GROUP BY I.ICUSTAY_ID
ORDER BY I.ICUSTAY_ID; 
--30.845


---------------------------------------------------------------------------------------------------------

--1st CRITERION : Scr increase of at least 0.3 within 48h 
--TAKE ALL Scr MEASUREMENTS TO INPUT INTO KNIME FOR THE WINDOW LOOP 
DROP TABLE IF EXISTS INPUT_KNIME_SCR;
SELECT DISTINCT IP.ICUSTAY_ID, L.CHARTTIME, L.VALUENUM, IP.INTIME, IP.OUTTIME 
INTO INPUT_KNIME_SCR
FROM MIMIC_UNTOUCHED.LABEVENTS L JOIN ICUSTAYS_PAT IP ON L.HADM_ID = IP.HADM_ID
WHERE   L.ITEMID = 50912 --CREATININE
	AND L.CHARTTIME >= IP.INTIME AND L.CHARTTIME <= IP.OUTTIME 
	AND L.VALUENUM  IS NOT NULL 
	AND IP.ICUSTAY_ID IS NOT NULL 
	AND IP.AGE BETWEEN 14 AND 89
ORDER BY IP.ICUSTAY_ID, L.CHARTTIME; 
--311.669


-- in knime: TABLE => ISABELA.AKI_1COND
-- 11.185 AKI 

---------------------------------------------------------------------------------------------------------

--2nd CRITERION: Scr >= 1.5*BASELINE, WHERE BASELINE = AVG(SCR) IN THE 7 DAYS PREVIOUS ICU ADMISSION
DROP TABLE IF EXISTS AVG_SCR_BEFOREICU;
SELECT IP.ICUSTAY_ID, ROUND(CAST(AVG(L.VALUENUM) AS NUMERIC),2) AS BASELINE 
INTO AVG_SCR_BEFOREICU
FROM MIMIC_UNTOUCHED.LABEVENTS L JOIN ICUSTAYS_PAT IP ON L.HADM_ID = IP.HADM_ID
WHERE L.ITEMID = 50912 --CREATININE
	AND IP.AGE BETWEEN 14 AND 89 
    AND L.VALUENUM IS NOT NULL 
	AND L.HADM_ID IS NOT NULL 
	AND (L.CHARTTIME < IP.INTIME AND L.CHARTTIME >= (IP.INTIME - INTERVAL '7 DAY'))
GROUP BY IP.ICUSTAY_ID
ORDER BY IP.ICUSTAY_ID;
--41.138
 

DROP TABLE IF EXISTS AKI_2COND;
SELECT  IP.ICUSTAY_ID, MIN(L.CHARTTIME) AS CHARTTIME_OF_AKI
INTO AKI_2COND 
FROM MIMIC_UNTOUCHED.LABEVENTS L JOIN ICUSTAYS_PAT IP ON L.HADM_ID = IP.HADM_ID
	JOIN AVG_SCR_BEFOREICU AC ON IP.ICUSTAY_ID = AC.ICUSTAY_ID
WHERE L.ITEMID = 50912 --CREATININE 
    AND L.VALUENUM IS NOT NULL 
	AND L.CHARTTIME >= IP.INTIME 
    AND L.CHARTTIME <= IP.OUTTIME
	AND L.VALUENUM >= 1.5*AC.BASELINE
	AND IP.AGE BETWEEN 14 AND 89 
GROUP BY IP.ICUSTAY_ID
ORDER BY IP.ICUSTAY_ID;
--3966 AKI 
 

---------------------------------------------------------------------------------------------------------

--3rd CRITERION : URINES OUTPUT/KG < 0.5 WITHIN 6H 
--TAKE ALL URINES MEASUREMENTS TO INPUT INTO KNIME FOR THE WINDOW LOOP 
DROP TABLE IF EXISTS INPUT_KNIME_URINES;
SELECT DISTINCT O.ICUSTAY_ID, O.CHARTTIME, O.VALUE,  W.AVG_WEIGHT
INTO INPUT_KNIME_URINES
FROM MIMIC_UNTOUCHED.OUTPUTEVENTS O JOIN WEIGHTS W ON O.ICUSTAY_ID = W.ICUSTAY_ID
	JOIN ICUSTAYS_PAT IP ON O.ICUSTAY_ID = IP.ICUSTAY_ID
WHERE   O.ITEMID IN (40055,43175,40069,40094,40715,40473,40085,40057,40056,
				   40405,40428,40086,40096,40651,226559,226560,226561,226584,
				   226563,226564,226565,226567,226557,226558,227488,227489)
	AND O.CHARTTIME >= IP.INTIME AND O.CHARTTIME <= IP.OUTTIME 
	AND O.VALUE  IS NOT NULL 
	AND O.ICUSTAY_ID IS NOT NULL 
	AND IP.AGE BETWEEN 14 AND 89
ORDER BY O.ICUSTAY_ID, O.CHARTTIME; 
--2.581.934


SELECT DISTINCT  ICUSTAY_ID
FROM INPUT_KNIME_URINES;
--29561


--DONE IN KNIME WORKFLOW: TABLE AKI_3COND
--IMPORT TABLE AKI_3COND INTO SERVER.
SELECT DISTINCT COUNT (ICUSTAY_ID)
FROM AKI_3COND;
--21887 WITH ALSO VALUES FOR VOLUME_PER_H_KG = 0


update aki_3cond 
set charttime_of_aki = '2200-04-01 07:00:00',
	volume_per_h_kg = 0.4761904761904762
where icustay_id = 203920;

update aki_3cond 
set charttime_of_aki = '2152-03-25 22:45:00',
	volume_per_h_kg = 0.4762264735177714
where icustay_id = 214810;

---------------------------------------------------------------------------------------------------------------------

---------------------------------------------------------------------------------------------------------------------

DROP TABLE IF EXISTS ICUSTAYS_PAT_FLAG;
SELECT  ICUSTAY_ID, AGE, GENDER, DEAD, INTIME, OUTTIME, HADM_ID,
CASE
	WHEN ICUSTAY_ID IN ( SELECT A.ICUSTAY_ID
						   FROM ISABELA.AKI_DISTINCT A  )
		THEN '1'::INTEGER 
	ELSE '0'::INTEGER
	END AS AKI_FLAG
INTO ICUSTAYS_PAT_FLAG
FROM  ICUSTAYS_PAT I --50711 TOT DI PARTENZA 
WHERE AGE BETWEEN 14 AND 89
ORDER BY I.ICUSTAY_ID;
--50711 TOT 
--IMPORTED INTO KNIME AND MODIFIED AS FOLLOWS: 
	-- TAKE THE CHARTTIME_OF_AKI FOR EACH AKI_FLAG = 1 (LEFT OUTER JOIN BETWEEN ICUSTAYS_PAT AND AKI_DISTINCT)
	-- MANTAIN CHARTTIME_OF_AKI NULL FOR EACH AKI_FLAG = 0 

SELECT * FROM ICUSTAYS_PAT_FLAG
WHERE AKI_FLAG = 1;
--25740 TOT 

SELECT * FROM ICUSTAYS_PAT_FLAG
WHERE AKI_FLAG = 0;
--24971


---------------------------------------------------------------------------------------------------------------------------------------------
-- COUNT AKI/NON-AKI IN THE DIFFERENT TIME INTERVALS 
---------------------------------------------------------------------------------------------------------------------------------------------

--CALCULATE ALL AKI IN 24H - (24H+7DAYS) TIME PERIOD 
SELECT COUNT ( ICUSTAY_ID )
FROM  ICUSTAYS_PAT_FLAG F  
WHERE AKI_FLAG = 1 AND 
	  CHARTTIME_OF_AKI > INTIME + INTERVAL '24 HOUR' AND 
	  CHARTTIME_OF_AKI <= INTIME + INTERVAL '24 HOUR' + INTERVAL '168 HOUR';
--7337

--CALCULATE ALL AKI IN 48H - (48H+7DAYS) TIME PERIOD 
SELECT COUNT ( ICUSTAY_ID )
FROM  ICUSTAYS_PAT_FLAG F  
WHERE AKI_FLAG = 1 AND 
	  CHARTTIME_OF_AKI > INTIME + INTERVAL '48 HOUR' AND 
	  CHARTTIME_OF_AKI <= INTIME + INTERVAL '48 HOUR' + INTERVAL '168 HOUR';
--2380

-- DOING IT TOGETHER for aki/non-aki 
--CALCULATE ALL AKI/NON-AKI IN 24H - (24H+7DAYS) TIME PERIOD 
SELECT COUNT ( ICUSTAY_ID )
FROM  ICUSTAYS_PAT_FLAG F  
WHERE AKI_FLAG = 1 AND 
	  CHARTTIME_OF_AKI > INTIME + INTERVAL '24 HOUR' AND 
	  CHARTTIME_OF_AKI <= INTIME + INTERVAL '24 HOUR' + INTERVAL '168 HOUR'
UNION ALL
SELECT COUNT ( ICUSTAY_ID)
FROM ICUSTAYS_PAT_FLAG F
WHERE AKI_FLAG = 0 AND OUTTIME > INTIME + INTERVAL '24 HOUR'
	OR ( AKI_FLAG = 1 AND  CHARTTIME_OF_AKI >= INTIME + INTERVAL '24 HOUR' + INTERVAL '168 HOUR');
--7337
--18834

--CALCULATE ALL AKI/NON-AKI  IN 48H - (48H+7DAYS) TIME PERIOD 
SELECT COUNT ( ICUSTAY_ID )
FROM  ICUSTAYS_PAT_FLAG F  
WHERE AKI_FLAG = 1 AND 
	  CHARTTIME_OF_AKI > INTIME + INTERVAL '48 HOUR' AND 
	  CHARTTIME_OF_AKI <= INTIME + INTERVAL '48 HOUR' + INTERVAL '168 HOUR'
UNION ALL
SELECT COUNT ( ICUSTAY_ID)
FROM ICUSTAYS_PAT_FLAG F
WHERE AKI_FLAG = 0 AND OUTTIME > INTIME + INTERVAL '48 HOUR'
	OR ( AKI_FLAG = 1 AND  CHARTTIME_OF_AKI >= INTIME + INTERVAL '48 HOUR' + INTERVAL '168 HOUR');
--2380
--8378

--CALCULATE ALL AKI/NON-AKI  IN 72H - (72H+7DAYS) TIME PERIOD 
SELECT COUNT ( ICUSTAY_ID )
FROM ICUSTAYS_PAT_FLAG F  
WHERE AKI_FLAG = 1 AND 
	  CHARTTIME_OF_AKI > INTIME + INTERVAL '72 HOUR' AND 
	  CHARTTIME_OF_AKI <= INTIME + INTERVAL '72 HOUR' + INTERVAL '168 HOUR'
UNION ALL
SELECT COUNT ( ICUSTAY_ID)
FROM ICUSTAYS_PAT_FLAG F
WHERE AKI_FLAG = 0 AND OUTTIME > INTIME + INTERVAL '72 HOUR'
	OR ( AKI_FLAG = 1 AND  CHARTTIME_OF_AKI >= INTIME + INTERVAL '72 HOUR' + INTERVAL '168 HOUR');
--1134
--4119

--CALCULATE ALL AKI/NON-AKI  IN 96H - (96H+7DAYS) TIME PERIOD 
SELECT COUNT ( ICUSTAY_ID )
FROM  ICUSTAYS_PAT_FLAG F  
WHERE AKI_FLAG = 1 AND 
	  CHARTTIME_OF_AKI > INTIME + INTERVAL '96 HOUR' AND 
	  CHARTTIME_OF_AKI <= INTIME + INTERVAL '96 HOUR' + INTERVAL '168 HOUR'
UNION ALL
SELECT COUNT ( ICUSTAY_ID)
FROM ICUSTAYS_PAT_FLAG F
WHERE AKI_FLAG = 0 AND OUTTIME > INTIME + INTERVAL '96 HOUR'
	OR ( AKI_FLAG = 1 AND  CHARTTIME_OF_AKI >= INTIME + INTERVAL '96 HOUR' + INTERVAL '168 HOUR');
--640
--2322

--CALCULATE ALL AKI/NON-AKI  IN 120H - (120H+7DAYS) TIME PERIOD 
SELECT COUNT ( ICUSTAY_ID )
FROM  ICUSTAYS_PAT_FLAG F  
WHERE AKI_FLAG = 1 AND 
	  CHARTTIME_OF_AKI > INTIME + INTERVAL '120 HOUR' AND 
	  CHARTTIME_OF_AKI <= INTIME + INTERVAL '120 HOUR' + INTERVAL '168 HOUR'
UNION ALL
SELECT COUNT ( ICUSTAY_ID)
FROM ICUSTAYS_PAT_FLAG F
WHERE AKI_FLAG = 0 AND OUTTIME > INTIME + INTERVAL '120 HOUR'
	OR ( AKI_FLAG = 1 AND  CHARTTIME_OF_AKI >= INTIME + INTERVAL '120 HOUR' + INTERVAL '168 HOUR');
--437
--1473

--CALCULATE ALL AKI/NON-AKI  IN 144H - (144H+7DAYS) TIME PERIOD 
SELECT COUNT ( ICUSTAY_ID )
FROM ICUSTAYS_PAT_FLAG F  
WHERE AKI_FLAG = 1 AND 
	  CHARTTIME_OF_AKI > INTIME + INTERVAL '144 HOUR' AND 
	  CHARTTIME_OF_AKI <= INTIME + INTERVAL '144 HOUR' + INTERVAL '168 HOUR'
UNION ALL
SELECT COUNT ( ICUSTAY_ID)
FROM ICUSTAYS_PAT_FLAG F
WHERE AKI_FLAG = 0 AND OUTTIME > INTIME + INTERVAL '144 HOUR'
	OR ( AKI_FLAG = 1 AND  CHARTTIME_OF_AKI >= INTIME + INTERVAL '144 HOUR' + INTERVAL '168 HOUR');
--312
--1034
--------------------------------------------------------------------------------------------------

---------------|----------|---------|----------|----------|----------|---------|
--             |  24H     |  48H    |   72H    |    96H   |   120H   |  144H   |
---------------|----------|---------|----------|----------|----------|---------|
--   AKI       |  7337    |  2380   |   1134   |   640    |   437    |  312    |
---------------|----------|---------|----------|----------|----------|---------|
--   NON AKI   |  18834   |  8378   |   4119   |   2322   |   1473   |  1034   |
---------------|----------|---------|----------|----------|----------|---------|
--  TOT        |   26171  |  10758  |  5253    |  2962    |   1910   |  1346   |
---------------|----------|---------|----------|----------|----------|---------|

---------------------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------------------

-- CONSIDERING THE STAY LASTING AT LEAST t HOURS and AKI_FLAG = 0 OR 1 IN PW.
DROP TABLE IF EXISTS DATA_24H;
SELECT ICUSTAY_ID, AKI_FLAG,GENDER, ETHNICITY,AGE, DEAD, HADM_ID, INTIME, OUTTIME
INTO DATA_24H
FROM ICUSTAYS_PAT_FLAG
WHERE OUTTIME-INTIME >= INTERVAL '24 HOUR' --stayed in icu at least 24H
	AND AKI_FLAG = 0 OR (AKI_FLAG = 1 AND CHARTTIME_OF_AKI > INTIME + INTERVAL '24 HOUR' 
	AND CHARTTIME_OF_AKI <= INTIME + INTERVAL '24 HOUR' + INTERVAL '168 HOUR');
--25940

DROP TABLE IF EXISTS DATA_48H;
SELECT ICUSTAY_ID, AKI_FLAG,GENDER,ETHNICITY, AGE, DEAD, HADM_ID, INTIME, OUTTIME
INTO DATA_48H
FROM ICUSTAYS_PAT_FLAG
WHERE OUTTIME-INTIME >= INTERVAL '48 HOUR' 
	AND AKI_FLAG = 0 OR (AKI_FLAG = 1 AND CHARTTIME_OF_AKI > INTIME + INTERVAL '48 HOUR' 
	AND CHARTTIME_OF_AKI <= INTIME + INTERVAL '48 HOUR' + INTERVAL '168 HOUR');
--10573

DROP TABLE IF EXISTS DATA_72H;
SELECT ICUSTAY_ID, AKI_FLAG,GENDER, ETHNICITY, AGE, DEAD, HADM_ID, INTIME, OUTTIME
INTO DATA_72H
FROM ICUSTAYS_PAT_FLAG
WHERE OUTTIME-INTIME >= INTERVAL '72 HOUR' 
	AND AKI_FLAG = 0 OR (AKI_FLAG = 1 AND CHARTTIME_OF_AKI > INTIME + INTERVAL '72 HOUR' 
	AND CHARTTIME_OF_AKI <= INTIME + INTERVAL '72 HOUR' + INTERVAL '168 HOUR');
--5107

DROP TABLE IF EXISTS DATA_96H;
SELECT ICUSTAY_ID, AKI_FLAG,GENDER,ETHNICITY, AGE, DEAD, HADM_ID, INTIME, OUTTIME
INTO DATA_96H
FROM ICUSTAYS_PAT_FLAG
WHERE OUTTIME-INTIME >= INTERVAL '96 HOUR' 
	AND AKI_FLAG = 0 OR (AKI_FLAG = 1 AND CHARTTIME_OF_AKI > INTIME + INTERVAL '96 HOUR' 
	AND CHARTTIME_OF_AKI <= INTIME + INTERVAL '96 HOUR' + INTERVAL '168 HOUR');
--2837

DROP TABLE IF EXISTS DATA_120H;
SELECT ICUSTAY_ID, AKI_FLAG,GENDER,ETHNICITY, AGE, DEAD, HADM_ID, INTIME, OUTTIME
INTO DATA_120H
FROM ICUSTAYS_PAT_FLAG
WHERE OUTTIME-INTIME >= INTERVAL '120 HOUR' 
	AND AKI_FLAG = 0 OR (AKI_FLAG = 1 AND CHARTTIME_OF_AKI > INTIME + INTERVAL '120 HOUR' 
	AND CHARTTIME_OF_AKI <= INTIME + INTERVAL '120 HOUR' + INTERVAL '168 HOUR');
--1809

DROP TABLE IF EXISTS DATA_144H;
SELECT ICUSTAY_ID, AKI_FLAG,GENDER, ETHNICITY, AGE, DEAD, HADM_ID, INTIME, OUTTIME
INTO DATA_144H
FROM ICUSTAYS_PAT_FLAG
WHERE OUTTIME-INTIME >= INTERVAL '144 HOUR' 
	AND AKI_FLAG = 0 OR (AKI_FLAG = 1 AND CHARTTIME_OF_AKI > INTIME + INTERVAL '144 HOUR' 
	AND CHARTTIME_OF_AKI <= INTIME + INTERVAL '144 HOUR' + INTERVAL '168 HOUR');
--1261



---------------------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------------------


 
