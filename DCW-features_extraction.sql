-- SELECT THE TABLEs CONTAINING THE PATIENTS OF THE DCW ON WHICH WE WILL MAKE THE PREDICTION.


DROP TABLE IF EXISTS ISABELA.DCW24H;
SELECT ICUSTAY_ID, AKI_FLAG,GENDER, ETHNICITY,AGE, DEAD, HADM_ID, INTIME, OUTTIME
INTO ISABELA.DCW24H
FROM ISABELA.ICUSTAYS_PAT_FLAG --50711 ELIGIBLE IDS
WHERE OUTTIME - INTIME >= INTERVAL '24 HOUR' --stayed in icu at least 24H  
	AND AKI_FLAG = 0 OR (AKI_FLAG = 1 AND CHARTTIME_OF_AKI > INTIME + INTERVAL '24 HOUR' 
	AND CHARTTIME_OF_AKI <= INTIME + INTERVAL '24 HOUR' + INTERVAL '168 HOUR');
--25940

DROP TABLE IF EXISTS ISABELA.DCW48H;
SELECT ICUSTAY_ID, AKI_FLAG,GENDER, ETHNICITY, AGE, DEAD, HADM_ID, INTIME, OUTTIME
INTO ISABELA.DCW48H
FROM ISABELA.ICUSTAYS_PAT_FLAG --50711 ELIGIBLE IDS
WHERE OUTTIME - INTIME >= INTERVAL '48 HOUR' --stayed in icu at least 24H  
	AND AKI_FLAG = 0 OR (AKI_FLAG = 1 AND CHARTTIME_OF_AKI > INTIME + INTERVAL '48 HOUR' 
	AND CHARTTIME_OF_AKI <= INTIME + INTERVAL '48 HOUR' + INTERVAL '168 HOUR');
--10573

DROP TABLE IF EXISTS ISABELA.DCW72H;
SELECT ICUSTAY_ID, AKI_FLAG,GENDER, ETHNICITY, AGE, DEAD, HADM_ID, INTIME, OUTTIME
INTO ISABELA.DCW72H
FROM ISABELA.ICUSTAYS_PAT_FLAG --50711 ELIGIBLE IDS
WHERE OUTTIME - INTIME >= INTERVAL '72 HOUR' --stayed in icu at least 24H  
	AND AKI_FLAG = 0 OR (AKI_FLAG = 1 AND CHARTTIME_OF_AKI > INTIME + INTERVAL '72 HOUR' 
	AND CHARTTIME_OF_AKI <= INTIME + INTERVAL '72 HOUR' + INTERVAL '168 HOUR');
--5107

DROP TABLE IF EXISTS ISABELA.DCW96H;
SELECT ICUSTAY_ID, AKI_FLAG,GENDER, ETHNICITY, AGE, DEAD, HADM_ID, INTIME, OUTTIME
INTO ISABELA.DCW96H
FROM ISABELA.ICUSTAYS_PAT_FLAG --50711 ELIGIBLE IDS
WHERE OUTTIME - INTIME >= INTERVAL '96 HOUR' --stayed in icu at least 24H  
	AND AKI_FLAG = 0 OR (AKI_FLAG = 1 AND CHARTTIME_OF_AKI > INTIME + INTERVAL '96 HOUR' 
	AND CHARTTIME_OF_AKI <= INTIME + INTERVAL '96 HOUR' + INTERVAL '168 HOUR');
--2837

DROP TABLE IF EXISTS ISABELA.DCW120H;
SELECT ICUSTAY_ID, AKI_FLAG,GENDER, ETHNICITY, AGE, DEAD, HADM_ID, INTIME, OUTTIME
INTO ISABELA.DCW120H
FROM ISABELA.ICUSTAYS_PAT_FLAG --50711 ELIGIBLE IDS
WHERE OUTTIME - INTIME >= INTERVAL '120 HOUR' --stayed in icu at least 24H  
	AND AKI_FLAG = 0 OR (AKI_FLAG = 1 AND CHARTTIME_OF_AKI > INTIME + INTERVAL '120 HOUR' 
	AND CHARTTIME_OF_AKI <= INTIME + INTERVAL '120 HOUR' + INTERVAL '168 HOUR');
--1809

DROP TABLE IF EXISTS ISABELA.DCW144H;
SELECT ICUSTAY_ID, AKI_FLAG,GENDER, ETHNICITY, AGE, DEAD, HADM_ID, INTIME, OUTTIME
INTO ISABELA.DCW144H
FROM ISABELA.ICUSTAYS_PAT_FLAG --50711 ELIGIBLE IDS
WHERE OUTTIME - INTIME >= INTERVAL '144 HOUR' --stayed in icu at least 24H  
	AND AKI_FLAG = 0 OR (AKI_FLAG = 1 AND CHARTTIME_OF_AKI > INTIME + INTERVAL '144 HOUR' 
	AND CHARTTIME_OF_AKI <= INTIME + INTERVAL '144 HOUR' + INTERVAL '168 HOUR');
--1261

---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

-- MEDICATIONS
DROP TABLE IF EXISTS ISABELA.MED_DCW24;
SELECT D.ICUSTAY_ID, D.AKI_FLAG,
MAX(CASE
	WHEN P.drug ILIKE'%ethiodol%'OR P.drug ILIKE '%lipiodol%' 
		THEN 1 ELSE 0 
	END ) AS RADIO,
MAX(CASE 
	WHEN P.drug ILIKE '%Benazepril%' OR P.drug ILIKE '%Captopril%' OR P.drug ILIKE '%Fosinopril%'OR P.drug ILIKE'%Moexipril%'OR P.drug ILIKE'%Enalapril%'OR P.drug ILIKE '%Lisinopril%'
		 OR P.drug ILIKE'%Perindopril%'OR P.drug ILIKE '%Quinapril%'OR P.drug ILIKE'%Ramipril%'OR P.drug ILIKE'%Trandolapril%'OR P.drug ILIKE'%Azilsartan%'OR P.drug ILIKE'%Candesartan%' 
		 OR P.drug ILIKE'%Eprosartan%'OR P.drug ILIKE '%Irbesartan%'OR P.drug ILIKE '%Losartan%'OR P.drug ILIKE'%Olmesartan%'OR P.drug ILIKE'%Telmisartan%'OR P.drug ILIKE'%Valsartan%'
		THEN 1 ELSE 0 
END ) AS ANGIO,
MAX(CASE 
	WHEN P.drug ILIKE '%chlorthalidone%'OR P.drug ILIKE '%hydrochlorothiazide%'OR P.drug ILIKE'%chlorothiazide%'OR P.drug ILIKE'%metolazone%'OR P.drug ILIKE'%indapamide%'OR P.drug ILIKE
		'%torsemide%'OR P.drug ILIKE '%furosemide%'OR P.drug ILIKE'%bumetanide%'OR P.drug ILIKE '%ethacrynic%acid%'OR P.drug ILIKE '%amiloride%'OR P.drug ILIKE'%spironolactone%'OR P.drug ILIKE
	    '%triamterene%'OR P.drug ILIKE '%eplerenone%'
		THEN 1 ELSE 0
END ) AS DIURETICS,
MAX(CASE 
	WHEN P.drug ILIKE '%aspirin%'OR P.drug ILIKE '%celecoxib%'OR P.drug ILIKE '%diclofenac%'OR P.drug ILIKE'%diflunisal%'OR P.drug ILIKE '%etodolac%'OR P.drug ILIKE'%ibuprofen%'OR P.drug ILIKE'%indomethacin%'
	OR P.drug ILIKE'%ketoprofen%'OR P.drug ILIKE'%ketorolac%'OR P.drug ILIKE'%nabumetone%'OR P.drug ILIKE'%naproxen%'OR P.drug ILIKE '%oxaprozin%'OR P.drug ILIKE '%piroxicam%'OR P.drug ILIKE '%salsalate%'
	OR P.drug ILIKE '%sulindac%'OR P.drug ILIKE'%tolmetin%' 
		THEN 1 ELSE 0 
END ) AS NSAID
INTO ISABELA.MED_DCW24
FROM  ISABELA.DCW24H D JOIN MIMIC_UNTOUCHED.PRESCRIPTIONS P 
	ON D.ICUSTAY_ID = P.ICUSTAY_ID
WHERE DATE_TRUNC('DAY', P.ENDDATE ) >= DATE_TRUNC('DAY', D.INTIME ) 
GROUP BY D.ICUSTAY_ID
ORDER BY D.ICUSTAY_ID
--23763

--THESE ARE THE PATIENTS THAT DID NOT TAKE ANY SPECIFIED MEDICATIONS
SELECT W.ICUSTAY_ID
FROM ISABELA.DCW24H W
WHERE W.ICUSTAY_ID NOT IN (
	SELECT D.ICUSTAY_ID
	FROM  ISABELA.MED_DCW24 D
 )
--2177

DROP TABLE IF EXISTS ISABELA.MED_DCW48;
SELECT D.ICUSTAY_ID, D.AKI_FLAG,
MAX(CASE
	WHEN P.drug ILIKE'%ethiodol%'OR P.drug ILIKE '%lipiodol%' 
		THEN 1 ELSE 0 
	END ) AS RADIO,
MAX(CASE 
	WHEN P.drug ILIKE '%Benazepril%' OR P.drug ILIKE '%Captopril%' OR P.drug ILIKE '%Fosinopril%'OR P.drug ILIKE'%Moexipril%'OR P.drug ILIKE'%Enalapril%'OR P.drug ILIKE '%Lisinopril%'
		 OR P.drug ILIKE'%Perindopril%'OR P.drug ILIKE '%Quinapril%'OR P.drug ILIKE'%Ramipril%'OR P.drug ILIKE'%Trandolapril%'OR P.drug ILIKE'%Azilsartan%'OR P.drug ILIKE'%Candesartan%' 
		 OR P.drug ILIKE'%Eprosartan%'OR P.drug ILIKE '%Irbesartan%'OR P.drug ILIKE '%Losartan%'OR P.drug ILIKE'%Olmesartan%'OR P.drug ILIKE'%Telmisartan%'OR P.drug ILIKE'%Valsartan%'
		THEN 1 ELSE 0 
END ) AS ANGIO,
MAX(CASE 
	WHEN P.drug ILIKE '%chlorthalidone%'OR P.drug ILIKE '%hydrochlorothiazide%'OR P.drug ILIKE'%chlorothiazide%'OR P.drug ILIKE'%metolazone%'OR P.drug ILIKE'%indapamide%'OR P.drug ILIKE
		'%torsemide%'OR P.drug ILIKE '%furosemide%'OR P.drug ILIKE'%bumetanide%'OR P.drug ILIKE '%ethacrynic%acid%'OR P.drug ILIKE '%amiloride%'OR P.drug ILIKE'%spironolactone%'OR P.drug ILIKE
	    '%triamterene%'OR P.drug ILIKE '%eplerenone%'
		THEN 1 ELSE 0
END ) AS DIURETICS,
MAX(CASE 
	WHEN P.drug ILIKE '%aspirin%'OR P.drug ILIKE '%celecoxib%'OR P.drug ILIKE '%diclofenac%'OR P.drug ILIKE'%diflunisal%'OR P.drug ILIKE '%etodolac%'OR P.drug ILIKE'%ibuprofen%'OR P.drug ILIKE'%indomethacin%'
	OR P.drug ILIKE'%ketoprofen%'OR P.drug ILIKE'%ketorolac%'OR P.drug ILIKE'%nabumetone%'OR P.drug ILIKE'%naproxen%'OR P.drug ILIKE '%oxaprozin%'OR P.drug ILIKE '%piroxicam%'OR P.drug ILIKE '%salsalate%'
	OR P.drug ILIKE '%sulindac%'OR P.drug ILIKE'%tolmetin%' 
		THEN 1 ELSE 0 
END ) AS NSAID
INTO ISABELA.MED_DCW48
FROM  ISABELA.DCW48H D JOIN MIMIC_UNTOUCHED.PRESCRIPTIONS P 
	ON D.ICUSTAY_ID = P.ICUSTAY_ID
WHERE DATE_TRUNC('DAY', P.ENDDATE ) >= DATE_TRUNC('DAY', D.INTIME ) 
GROUP BY D.ICUSTAY_ID,  D.AKI_FLAG
ORDER BY D.ICUSTAY_ID;
--9605



DROP TABLE IF EXISTS ISABELA.MED_DCW72;
SELECT D.ICUSTAY_ID, D.AKI_FLAG,
MAX(CASE
	WHEN P.drug ILIKE'%ethiodol%'OR P.drug ILIKE '%lipiodol%' 
		THEN 1 ELSE 0 
	END ) AS RADIO,
MAX(CASE 
	WHEN P.drug ILIKE '%Benazepril%' OR P.drug ILIKE '%Captopril%' OR P.drug ILIKE '%Fosinopril%'OR P.drug ILIKE'%Moexipril%'OR P.drug ILIKE'%Enalapril%'OR P.drug ILIKE '%Lisinopril%'
		 OR P.drug ILIKE'%Perindopril%'OR P.drug ILIKE '%Quinapril%'OR P.drug ILIKE'%Ramipril%'OR P.drug ILIKE'%Trandolapril%'OR P.drug ILIKE'%Azilsartan%'OR P.drug ILIKE'%Candesartan%' 
		 OR P.drug ILIKE'%Eprosartan%'OR P.drug ILIKE '%Irbesartan%'OR P.drug ILIKE '%Losartan%'OR P.drug ILIKE'%Olmesartan%'OR P.drug ILIKE'%Telmisartan%'OR P.drug ILIKE'%Valsartan%'
		THEN 1 ELSE 0 
END ) AS ANGIO,
MAX(CASE 
	WHEN P.drug ILIKE '%chlorthalidone%'OR P.drug ILIKE '%hydrochlorothiazide%'OR P.drug ILIKE'%chlorothiazide%'OR P.drug ILIKE'%metolazone%'OR P.drug ILIKE'%indapamide%'OR P.drug ILIKE
		'%torsemide%'OR P.drug ILIKE '%furosemide%'OR P.drug ILIKE'%bumetanide%'OR P.drug ILIKE '%ethacrynic%acid%'OR P.drug ILIKE '%amiloride%'OR P.drug ILIKE'%spironolactone%'OR P.drug ILIKE
	    '%triamterene%'OR P.drug ILIKE '%eplerenone%'
		THEN 1 ELSE 0
END ) AS DIURETICS,
MAX(CASE 
	WHEN P.drug ILIKE '%aspirin%'OR P.drug ILIKE '%celecoxib%'OR P.drug ILIKE '%diclofenac%'OR P.drug ILIKE'%diflunisal%'OR P.drug ILIKE '%etodolac%'OR P.drug ILIKE'%ibuprofen%'OR P.drug ILIKE'%indomethacin%'
	OR P.drug ILIKE'%ketoprofen%'OR P.drug ILIKE'%ketorolac%'OR P.drug ILIKE'%nabumetone%'OR P.drug ILIKE'%naproxen%'OR P.drug ILIKE '%oxaprozin%'OR P.drug ILIKE '%piroxicam%'OR P.drug ILIKE '%salsalate%'
	OR P.drug ILIKE '%sulindac%'OR P.drug ILIKE'%tolmetin%' 
		THEN 1 ELSE 0 
END ) AS NSAID
INTO ISABELA.MED_DCW72
FROM  ISABELA.DCW72H D JOIN MIMIC_UNTOUCHED.PRESCRIPTIONS P 
	ON D.ICUSTAY_ID = P.ICUSTAY_ID
WHERE DATE_TRUNC('DAY', P.ENDDATE ) >= DATE_TRUNC('DAY', D.INTIME ) 
GROUP BY D.ICUSTAY_ID,  D.AKI_FLAG
ORDER BY D.ICUSTAY_ID;
--4576



DROP TABLE IF EXISTS ISABELA.MED_DCW96;
SELECT D.ICUSTAY_ID, D.AKI_FLAG,
MAX(CASE
	WHEN P.drug ILIKE'%ethiodol%'OR P.drug ILIKE '%lipiodol%' 
		THEN 1 ELSE 0 
	END ) AS RADIO,
MAX(CASE 
	WHEN P.drug ILIKE '%Benazepril%' OR P.drug ILIKE '%Captopril%' OR P.drug ILIKE '%Fosinopril%'OR P.drug ILIKE'%Moexipril%'OR P.drug ILIKE'%Enalapril%'OR P.drug ILIKE '%Lisinopril%'
		 OR P.drug ILIKE'%Perindopril%'OR P.drug ILIKE '%Quinapril%'OR P.drug ILIKE'%Ramipril%'OR P.drug ILIKE'%Trandolapril%'OR P.drug ILIKE'%Azilsartan%'OR P.drug ILIKE'%Candesartan%' 
		 OR P.drug ILIKE'%Eprosartan%'OR P.drug ILIKE '%Irbesartan%'OR P.drug ILIKE '%Losartan%'OR P.drug ILIKE'%Olmesartan%'OR P.drug ILIKE'%Telmisartan%'OR P.drug ILIKE'%Valsartan%'
		THEN 1 ELSE 0 
END ) AS ANGIO,
MAX(CASE 
	WHEN P.drug ILIKE '%chlorthalidone%'OR P.drug ILIKE '%hydrochlorothiazide%'OR P.drug ILIKE'%chlorothiazide%'OR P.drug ILIKE'%metolazone%'OR P.drug ILIKE'%indapamide%'OR P.drug ILIKE
		'%torsemide%'OR P.drug ILIKE '%furosemide%'OR P.drug ILIKE'%bumetanide%'OR P.drug ILIKE '%ethacrynic%acid%'OR P.drug ILIKE '%amiloride%'OR P.drug ILIKE'%spironolactone%'OR P.drug ILIKE
	    '%triamterene%'OR P.drug ILIKE '%eplerenone%'
		THEN 1 ELSE 0
END ) AS DIURETICS,
MAX(CASE 
	WHEN P.drug ILIKE '%aspirin%'OR P.drug ILIKE '%celecoxib%'OR P.drug ILIKE '%diclofenac%'OR P.drug ILIKE'%diflunisal%'OR P.drug ILIKE '%etodolac%'OR P.drug ILIKE'%ibuprofen%'OR P.drug ILIKE'%indomethacin%'
	OR P.drug ILIKE'%ketoprofen%'OR P.drug ILIKE'%ketorolac%'OR P.drug ILIKE'%nabumetone%'OR P.drug ILIKE'%naproxen%'OR P.drug ILIKE '%oxaprozin%'OR P.drug ILIKE '%piroxicam%'OR P.drug ILIKE '%salsalate%'
	OR P.drug ILIKE '%sulindac%'OR P.drug ILIKE'%tolmetin%' 
		THEN 1 ELSE 0 
END ) AS NSAID
INTO ISABELA.MED_DCW96
FROM  ISABELA.DCW96H D JOIN MIMIC_UNTOUCHED.PRESCRIPTIONS P 
	ON D.ICUSTAY_ID = P.ICUSTAY_ID
WHERE DATE_TRUNC('DAY', P.ENDDATE ) >= DATE_TRUNC('DAY', D.INTIME ) 
GROUP BY D.ICUSTAY_ID,  D.AKI_FLAG
ORDER BY D.ICUSTAY_ID;
--2512


DROP TABLE IF EXISTS ISABELA.MED_DCW120;
SELECT D.ICUSTAY_ID, D.AKI_FLAG,
MAX(CASE
	WHEN P.drug ILIKE'%ethiodol%'OR P.drug ILIKE '%lipiodol%' 
		THEN 1 ELSE 0 
	END ) AS RADIO,
MAX(CASE 
	WHEN P.drug ILIKE '%Benazepril%' OR P.drug ILIKE '%Captopril%' OR P.drug ILIKE '%Fosinopril%'OR P.drug ILIKE'%Moexipril%'OR P.drug ILIKE'%Enalapril%'OR P.drug ILIKE '%Lisinopril%'
		 OR P.drug ILIKE'%Perindopril%'OR P.drug ILIKE '%Quinapril%'OR P.drug ILIKE'%Ramipril%'OR P.drug ILIKE'%Trandolapril%'OR P.drug ILIKE'%Azilsartan%'OR P.drug ILIKE'%Candesartan%' 
		 OR P.drug ILIKE'%Eprosartan%'OR P.drug ILIKE '%Irbesartan%'OR P.drug ILIKE '%Losartan%'OR P.drug ILIKE'%Olmesartan%'OR P.drug ILIKE'%Telmisartan%'OR P.drug ILIKE'%Valsartan%'
		THEN 1 ELSE 0 
END ) AS ANGIO,
MAX(CASE 
	WHEN P.drug ILIKE '%chlorthalidone%'OR P.drug ILIKE '%hydrochlorothiazide%'OR P.drug ILIKE'%chlorothiazide%'OR P.drug ILIKE'%metolazone%'OR P.drug ILIKE'%indapamide%'OR P.drug ILIKE
		'%torsemide%'OR P.drug ILIKE '%furosemide%'OR P.drug ILIKE'%bumetanide%'OR P.drug ILIKE '%ethacrynic%acid%'OR P.drug ILIKE '%amiloride%'OR P.drug ILIKE'%spironolactone%'OR P.drug ILIKE
	    '%triamterene%'OR P.drug ILIKE '%eplerenone%'
		THEN 1 ELSE 0
END ) AS DIURETICS,
MAX(CASE 
	WHEN P.drug ILIKE '%aspirin%'OR P.drug ILIKE '%celecoxib%'OR P.drug ILIKE '%diclofenac%'OR P.drug ILIKE'%diflunisal%'OR P.drug ILIKE '%etodolac%'OR P.drug ILIKE'%ibuprofen%'OR P.drug ILIKE'%indomethacin%'
	OR P.drug ILIKE'%ketoprofen%'OR P.drug ILIKE'%ketorolac%'OR P.drug ILIKE'%nabumetone%'OR P.drug ILIKE'%naproxen%'OR P.drug ILIKE '%oxaprozin%'OR P.drug ILIKE '%piroxicam%'OR P.drug ILIKE '%salsalate%'
	OR P.drug ILIKE '%sulindac%'OR P.drug ILIKE'%tolmetin%' 
		THEN 1 ELSE 0 
END ) AS NSAID
INTO ISABELA.MED_DCW120
FROM  ISABELA.DCW120H D JOIN MIMIC_UNTOUCHED.PRESCRIPTIONS P 
	ON D.ICUSTAY_ID = P.ICUSTAY_ID
WHERE DATE_TRUNC('DAY', P.ENDDATE ) >= DATE_TRUNC('DAY', D.INTIME ) 
GROUP BY D.ICUSTAY_ID,  D.AKI_FLAG
ORDER BY D.ICUSTAY_ID;
--1577


DROP TABLE IF EXISTS ISABELA.MED_DCW144;
SELECT D.ICUSTAY_ID, D.AKI_FLAG,
MAX(CASE
	WHEN P.drug ILIKE'%ethiodol%'OR P.drug ILIKE '%lipiodol%' 
		THEN 1 ELSE 0 
	END ) AS RADIO,
MAX(CASE 
	WHEN P.drug ILIKE '%Benazepril%' OR P.drug ILIKE '%Captopril%' OR P.drug ILIKE '%Fosinopril%'OR P.drug ILIKE'%Moexipril%'OR P.drug ILIKE'%Enalapril%'OR P.drug ILIKE '%Lisinopril%'
		 OR P.drug ILIKE'%Perindopril%'OR P.drug ILIKE '%Quinapril%'OR P.drug ILIKE'%Ramipril%'OR P.drug ILIKE'%Trandolapril%'OR P.drug ILIKE'%Azilsartan%'OR P.drug ILIKE'%Candesartan%' 
		 OR P.drug ILIKE'%Eprosartan%'OR P.drug ILIKE '%Irbesartan%'OR P.drug ILIKE '%Losartan%'OR P.drug ILIKE'%Olmesartan%'OR P.drug ILIKE'%Telmisartan%'OR P.drug ILIKE'%Valsartan%'
		THEN 1 ELSE 0 
END ) AS ANGIO,
MAX(CASE 
	WHEN P.drug ILIKE '%chlorthalidone%'OR P.drug ILIKE '%hydrochlorothiazide%'OR P.drug ILIKE'%chlorothiazide%'OR P.drug ILIKE'%metolazone%'OR P.drug ILIKE'%indapamide%'OR P.drug ILIKE
		'%torsemide%'OR P.drug ILIKE '%furosemide%'OR P.drug ILIKE'%bumetanide%'OR P.drug ILIKE '%ethacrynic%acid%'OR P.drug ILIKE '%amiloride%'OR P.drug ILIKE'%spironolactone%'OR P.drug ILIKE
	    '%triamterene%'OR P.drug ILIKE '%eplerenone%'
		THEN 1 ELSE 0
END ) AS DIURETICS,
MAX(CASE 
	WHEN P.drug ILIKE '%aspirin%'OR P.drug ILIKE '%celecoxib%'OR P.drug ILIKE '%diclofenac%'OR P.drug ILIKE'%diflunisal%'OR P.drug ILIKE '%etodolac%'OR P.drug ILIKE'%ibuprofen%'OR P.drug ILIKE'%indomethacin%'
	OR P.drug ILIKE'%ketoprofen%'OR P.drug ILIKE'%ketorolac%'OR P.drug ILIKE'%nabumetone%'OR P.drug ILIKE'%naproxen%'OR P.drug ILIKE '%oxaprozin%'OR P.drug ILIKE '%piroxicam%'OR P.drug ILIKE '%salsalate%'
	OR P.drug ILIKE '%sulindac%'OR P.drug ILIKE'%tolmetin%' 
		THEN 1 ELSE 0 
END ) AS NSAID
INTO ISABELA.MED_DCW144
FROM  ISABELA.DCW144H D JOIN MIMIC_UNTOUCHED.PRESCRIPTIONS P 
	ON D.ICUSTAY_ID = P.ICUSTAY_ID
WHERE DATE_TRUNC('DAY', P.ENDDATE ) >= DATE_TRUNC('DAY', D.INTIME ) 
GROUP BY D.ICUSTAY_ID,  D.AKI_FLAG
ORDER BY D.ICUSTAY_ID;
--1090
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

-- COMORBIDITIES
DROP TABLE IF EXISTS ISABELA.COM_DCW24;
SELECT D24.ICUSTAY_ID, D24.AKI_FLAG, 
MAX(CASE 
    WHEN DC.ICD9_CODE = '4280' THEN 1 ELSE 0 
END )AS Congestive_heart_failure,
MAX(CASE
    WHEN DC.ICD9_CODE IN ('44389','4439','74769','9972') THEN 1 ELSE 0 
END) AS Peripheral_vascular,
MAX(CASE 
    WHEN DC.ICD9_CODE IN ('3482', '4010','4011','4019','40501','40511','40591','40599','4160','5723','64201','64203','64204','64214','64224','64231','64233','64234',
        '64271','64274','64292','64293','64294','64621','64623','7962','99791') THEN 1 ELSE 0 
END) AS  Hypertension, 
MAX(CASE 
WHEN DC.ICD9_CODE IN ('24900','24901','24911','24950','24960','24980', '24981', '24990',
	    '24991','25000','25001','25002','25003','25010','25011','25012','25013','25020','25021','25022','25023','25030','25031','25032','25033','25040','25041',
        '25042','25043','25050','25051','25051','25052','25053','25060','25061','25062','25063','25070','25071','25072','25073','25080','25081','25082','25083',
        '25090','25091','25092','25093','2535','3572','5881','64801','64803','64804','V180') THEN 1 ELSE 0 
END) AS Diabetes,
MAX( CASE 
    WHEN DC.ICD9_CODE IN ('5718','5719','5728','570') THEN 1 ELSE 0
END) AS  Liver_diseases, 
MAX(CASE 
    WHEN DC.ICD9_CODE IN ('41020','41091','41081','41011','41032','412','41022','41002','42979','41000','41012','41181','41010','41040','41051','41001',
        '4110','41041','41082', '41092','41090','41031','41021','41042') THEN 1 ELSE 0 
END) AS Myocardial_infarction,
MAX(CASE 
    WHEN DC.ICD9_CODE IN ('41401','41412','4142') THEN 1 ELSE 0 
END) AS Coronary_artery_disease,
MAX(CASE
    WHEN DC.ICD9_CODE IN ('5712', '5715', '5716') THEN 1 ELSE 0
END) AS Cirrhosis,
MAX(CASE
    WHEN DC.ICD9_CODE = '7824' THEN 1 ELSE 0
END) AS Jaundic
INTO ISABELA.COM_DCW24
FROM ISABELA.DCW24H D24 JOIN MIMIC_UNTOUCHED.DIAGNOSES_ICD D ON  D24.HADM_ID = D.HADM_ID
 	JOIN MIMIC_UNTOUCHED.D_ICD_DIAGNOSES DC ON D.ICD9_CODE = DC.ICD9_CODE
GROUP BY D24.ICUSTAY_ID, D24.AKI_FLAG
ORDER BY D24.ICUSTAY_ID;
--25939


-- THIS PATIENT HAS NO VALUES FOR COMORBIDITIES
SELECT D.ICUSTAY_ID FROM ISABELA.DCW24H D 
WHERE D.ICUSTAY_ID NOT IN ( 
SELECT C.ICUSTAY_ID FROM ISABELA.COM_DCW24 C);
-- ICUSTAY_ID = 240408


---VERIFY THIS PAT ON MIMIC DIRECTLY
SELECT I.ICUSTAY_ID,
MAX(CASE 
    WHEN DC.ICD9_CODE = '4280' THEN 1 ELSE 0 
END )AS Congestive_heart_failure,
MAX(CASE
    WHEN DC.ICD9_CODE IN ('44389','4439','74769','9972') THEN 1 ELSE 0 
END) AS Peripheral_vascular,
MAX(CASE 
    WHEN DC.ICD9_CODE IN ('3482', '4010','4011','4019','40501','40511','40591','40599','4160','5723','64201','64203','64204','64214','64224','64231','64233','64234',
        '64271','64274','64292','64293','64294','64621','64623','7962','99791') THEN 1 ELSE 0 
END) AS  Hypertension, 
MAX(CASE 
WHEN DC.ICD9_CODE IN ('24900','24901','24911','24950','24960','24980', '24981', '24990',
	    '24991','25000','25001','25002','25003','25010','25011','25012','25013','25020','25021','25022','25023','25030','25031','25032','25033','25040','25041',
        '25042','25043','25050','25051','25051','25052','25053','25060','25061','25062','25063','25070','25071','25072','25073','25080','25081','25082','25083',
        '25090','25091','25092','25093','2535','3572','5881','64801','64803','64804','V180') THEN 1 ELSE 0 
END) AS Diabetes,
MAX( CASE 
    WHEN DC.ICD9_CODE IN ('5718','5719','5728','570') THEN 1 ELSE 0
END) AS  Liver_diseases, 
MAX(CASE 
    WHEN DC.ICD9_CODE IN ('41020','41091','41081','41011','41032','412','41022','41002','42979','41000','41012','41181','41010','41040','41051','41001',
        '4110','41041','41082', '41092','41090','41031','41021','41042') THEN 1 ELSE 0 
END) AS Myocardial_infarction,
MAX(CASE 
    WHEN DC.ICD9_CODE IN ('41401','41412','4142') THEN 1 ELSE 0 
END) AS Coronary_artery_disease,
MAX(CASE
    WHEN DC.ICD9_CODE IN ('5712', '5715', '5716') THEN 1 ELSE 0
END) AS Cirrhosis,
MAX(CASE
    WHEN DC.ICD9_CODE = '7824' THEN 1 ELSE 0
END) AS Jaundic
FROM MIMIC_UNTOUCHED.ICUSTAYS I JOIN MIMIC_UNTOUCHED.DIAGNOSES_ICD D ON  I.HADM_ID = D.HADM_ID
 	JOIN MIMIC_UNTOUCHED.D_ICD_DIAGNOSES DC ON D.ICD9_CODE = DC.ICD9_CODE
WHERE I.ICUSTAY_ID = 240408
GROUP BY I.ICUSTAY_ID
ORDER BY I.ICUSTAY_ID;
--MISSING VALUES



DROP TABLE IF EXISTS ISABELA.COM_DCW48;
SELECT D24.ICUSTAY_ID, D24.AKI_FLAG, 
MAX(CASE 
    WHEN DC.ICD9_CODE = '4280' THEN 1 ELSE 0 
END )AS Congestive_heart_failure,
MAX(CASE
    WHEN DC.ICD9_CODE IN ('44389','4439','74769','9972') THEN 1 ELSE 0 
END) AS Peripheral_vascular,
MAX(CASE 
    WHEN DC.ICD9_CODE IN ('3482', '4010','4011','4019','40501','40511','40591','40599','4160','5723','64201','64203','64204','64214','64224','64231','64233','64234',
        '64271','64274','64292','64293','64294','64621','64623','7962','99791') THEN 1 ELSE 0 
END) AS  Hypertension, 
MAX(CASE 
WHEN DC.ICD9_CODE IN ('24900','24901','24911','24950','24960','24980', '24981', '24990',
	    '24991','25000','25001','25002','25003','25010','25011','25012','25013','25020','25021','25022','25023','25030','25031','25032','25033','25040','25041',
        '25042','25043','25050','25051','25051','25052','25053','25060','25061','25062','25063','25070','25071','25072','25073','25080','25081','25082','25083',
        '25090','25091','25092','25093','2535','3572','5881','64801','64803','64804','V180') THEN 1 ELSE 0 
END) AS Diabetes,
MAX( CASE 
    WHEN DC.ICD9_CODE IN ('5718','5719','5728','570') THEN 1 ELSE 0
END) AS  Liver_diseases, 
MAX(CASE 
    WHEN DC.ICD9_CODE IN ('41020','41091','41081','41011','41032','412','41022','41002','42979','41000','41012','41181','41010','41040','41051','41001',
        '4110','41041','41082', '41092','41090','41031','41021','41042') THEN 1 ELSE 0 
END) AS Myocardial_infarction,
MAX(CASE 
    WHEN DC.ICD9_CODE IN ('41401','41412','4142') THEN 1 ELSE 0 
END) AS Coronary_artery_disease,
MAX(CASE
    WHEN DC.ICD9_CODE IN ('5712', '5715', '5716') THEN 1 ELSE 0
END) AS Cirrhosis,
MAX(CASE
    WHEN DC.ICD9_CODE = '7824' THEN 1 ELSE 0
END) AS Jaundic
INTO ISABELA.COM_DCW48
FROM ISABELA.DCW48H D24 JOIN MIMIC_UNTOUCHED.DIAGNOSES_ICD D ON  D24.HADM_ID = D.HADM_ID
 	JOIN MIMIC_UNTOUCHED.D_ICD_DIAGNOSES DC ON D.ICD9_CODE = DC.ICD9_CODE
GROUP BY D24.ICUSTAY_ID, D24.AKI_FLAG
ORDER BY D24.ICUSTAY_ID;
--10573



DROP TABLE IF EXISTS ISABELA.COM_DCW72;
SELECT D24.ICUSTAY_ID, D24.AKI_FLAG, 
MAX(CASE 
    WHEN DC.ICD9_CODE = '4280' THEN 1 ELSE 0 
END )AS Congestive_heart_failure,
MAX(CASE
    WHEN DC.ICD9_CODE IN ('44389','4439','74769','9972') THEN 1 ELSE 0 
END) AS Peripheral_vascular,
MAX(CASE 
    WHEN DC.ICD9_CODE IN ('3482', '4010','4011','4019','40501','40511','40591','40599','4160','5723','64201','64203','64204','64214','64224','64231','64233','64234',
        '64271','64274','64292','64293','64294','64621','64623','7962','99791') THEN 1 ELSE 0 
END) AS  Hypertension, 
MAX(CASE 
WHEN DC.ICD9_CODE IN ('24900','24901','24911','24950','24960','24980', '24981', '24990',
	    '24991','25000','25001','25002','25003','25010','25011','25012','25013','25020','25021','25022','25023','25030','25031','25032','25033','25040','25041',
        '25042','25043','25050','25051','25051','25052','25053','25060','25061','25062','25063','25070','25071','25072','25073','25080','25081','25082','25083',
        '25090','25091','25092','25093','2535','3572','5881','64801','64803','64804','V180') THEN 1 ELSE 0 
END) AS Diabetes,
MAX( CASE 
    WHEN DC.ICD9_CODE IN ('5718','5719','5728','570') THEN 1 ELSE 0
END) AS  Liver_diseases, 
MAX(CASE 
    WHEN DC.ICD9_CODE IN ('41020','41091','41081','41011','41032','412','41022','41002','42979','41000','41012','41181','41010','41040','41051','41001',
        '4110','41041','41082', '41092','41090','41031','41021','41042') THEN 1 ELSE 0 
END) AS Myocardial_infarction,
MAX(CASE 
    WHEN DC.ICD9_CODE IN ('41401','41412','4142') THEN 1 ELSE 0 
END) AS Coronary_artery_disease,
MAX(CASE
    WHEN DC.ICD9_CODE IN ('5712', '5715', '5716') THEN 1 ELSE 0
END) AS Cirrhosis,
MAX(CASE
    WHEN DC.ICD9_CODE = '7824' THEN 1 ELSE 0
END) AS Jaundic
INTO ISABELA.COM_DCW72
FROM ISABELA.DCW72H D24 JOIN MIMIC_UNTOUCHED.DIAGNOSES_ICD D ON  D24.HADM_ID = D.HADM_ID
 	JOIN MIMIC_UNTOUCHED.D_ICD_DIAGNOSES DC ON D.ICD9_CODE = DC.ICD9_CODE
GROUP BY D24.ICUSTAY_ID, D24.AKI_FLAG
ORDER BY D24.ICUSTAY_ID;
--5107


DROP TABLE IF EXISTS ISABELA.COM_DCW96;
SELECT D24.ICUSTAY_ID, D24.AKI_FLAG, 
MAX(CASE 
    WHEN DC.ICD9_CODE = '4280' THEN 1 ELSE 0 
END )AS Congestive_heart_failure,
MAX(CASE
    WHEN DC.ICD9_CODE IN ('44389','4439','74769','9972') THEN 1 ELSE 0 
END) AS Peripheral_vascular,
MAX(CASE 
    WHEN DC.ICD9_CODE IN ('3482', '4010','4011','4019','40501','40511','40591','40599','4160','5723','64201','64203','64204','64214','64224','64231','64233','64234',
        '64271','64274','64292','64293','64294','64621','64623','7962','99791') THEN 1 ELSE 0 
END) AS  Hypertension, 
MAX(CASE 
WHEN DC.ICD9_CODE IN ('24900','24901','24911','24950','24960','24980', '24981', '24990',
	    '24991','25000','25001','25002','25003','25010','25011','25012','25013','25020','25021','25022','25023','25030','25031','25032','25033','25040','25041',
        '25042','25043','25050','25051','25051','25052','25053','25060','25061','25062','25063','25070','25071','25072','25073','25080','25081','25082','25083',
        '25090','25091','25092','25093','2535','3572','5881','64801','64803','64804','V180') THEN 1 ELSE 0 
END) AS Diabetes,
MAX( CASE 
    WHEN DC.ICD9_CODE IN ('5718','5719','5728','570') THEN 1 ELSE 0
END) AS  Liver_diseases, 
MAX(CASE 
    WHEN DC.ICD9_CODE IN ('41020','41091','41081','41011','41032','412','41022','41002','42979','41000','41012','41181','41010','41040','41051','41001',
        '4110','41041','41082', '41092','41090','41031','41021','41042') THEN 1 ELSE 0 
END) AS Myocardial_infarction,
MAX(CASE 
    WHEN DC.ICD9_CODE IN ('41401','41412','4142') THEN 1 ELSE 0 
END) AS Coronary_artery_disease,
MAX(CASE
    WHEN DC.ICD9_CODE IN ('5712', '5715', '5716') THEN 1 ELSE 0
END) AS Cirrhosis,
MAX(CASE
    WHEN DC.ICD9_CODE = '7824' THEN 1 ELSE 0
END) AS Jaundic
INTO ISABELA.COM_DCW96
FROM ISABELA.DCW96H D24 JOIN MIMIC_UNTOUCHED.DIAGNOSES_ICD D ON  D24.HADM_ID = D.HADM_ID
 	JOIN MIMIC_UNTOUCHED.D_ICD_DIAGNOSES DC ON D.ICD9_CODE = DC.ICD9_CODE
GROUP BY D24.ICUSTAY_ID, D24.AKI_FLAG
ORDER BY D24.ICUSTAY_ID;
--2837


DROP TABLE IF EXISTS ISABELA.COM_DCW120;
SELECT D24.ICUSTAY_ID, D24.AKI_FLAG, 
MAX(CASE 
    WHEN DC.ICD9_CODE = '4280' THEN 1 ELSE 0 
END )AS Congestive_heart_failure,
MAX(CASE
    WHEN DC.ICD9_CODE IN ('44389','4439','74769','9972') THEN 1 ELSE 0 
END) AS Peripheral_vascular,
MAX(CASE 
    WHEN DC.ICD9_CODE IN ('3482', '4010','4011','4019','40501','40511','40591','40599','4160','5723','64201','64203','64204','64214','64224','64231','64233','64234',
        '64271','64274','64292','64293','64294','64621','64623','7962','99791') THEN 1 ELSE 0 
END) AS  Hypertension, 
MAX(CASE 
WHEN DC.ICD9_CODE IN ('24900','24901','24911','24950','24960','24980', '24981', '24990',
	    '24991','25000','25001','25002','25003','25010','25011','25012','25013','25020','25021','25022','25023','25030','25031','25032','25033','25040','25041',
        '25042','25043','25050','25051','25051','25052','25053','25060','25061','25062','25063','25070','25071','25072','25073','25080','25081','25082','25083',
        '25090','25091','25092','25093','2535','3572','5881','64801','64803','64804','V180') THEN 1 ELSE 0 
END) AS Diabetes,
MAX( CASE 
    WHEN DC.ICD9_CODE IN ('5718','5719','5728','570') THEN 1 ELSE 0
END) AS  Liver_diseases, 
MAX(CASE 
    WHEN DC.ICD9_CODE IN ('41020','41091','41081','41011','41032','412','41022','41002','42979','41000','41012','41181','41010','41040','41051','41001',
        '4110','41041','41082', '41092','41090','41031','41021','41042') THEN 1 ELSE 0 
END) AS Myocardial_infarction,
MAX(CASE 
    WHEN DC.ICD9_CODE IN ('41401','41412','4142') THEN 1 ELSE 0 
END) AS Coronary_artery_disease,
MAX(CASE
    WHEN DC.ICD9_CODE IN ('5712', '5715', '5716') THEN 1 ELSE 0
END) AS Cirrhosis,
MAX(CASE
    WHEN DC.ICD9_CODE = '7824' THEN 1 ELSE 0
END) AS Jaundic
INTO ISABELA.COM_DCW120
FROM ISABELA.DCW120H D24 JOIN MIMIC_UNTOUCHED.DIAGNOSES_ICD D ON  D24.HADM_ID = D.HADM_ID
 	JOIN MIMIC_UNTOUCHED.D_ICD_DIAGNOSES DC ON D.ICD9_CODE = DC.ICD9_CODE
GROUP BY D24.ICUSTAY_ID, D24.AKI_FLAG
ORDER BY D24.ICUSTAY_ID;
--1809



DROP TABLE IF EXISTS ISABELA.COM_DCW144;
SELECT D24.ICUSTAY_ID, D24.AKI_FLAG, 
MAX(CASE 
    WHEN DC.ICD9_CODE = '4280' THEN 1 ELSE 0 
END )AS Congestive_heart_failure,
MAX(CASE
    WHEN DC.ICD9_CODE IN ('44389','4439','74769','9972') THEN 1 ELSE 0 
END) AS Peripheral_vascular,
MAX(CASE 
    WHEN DC.ICD9_CODE IN ('3482', '4010','4011','4019','40501','40511','40591','40599','4160','5723','64201','64203','64204','64214','64224','64231','64233','64234',
        '64271','64274','64292','64293','64294','64621','64623','7962','99791') THEN 1 ELSE 0 
END) AS  Hypertension, 
MAX(CASE 
WHEN DC.ICD9_CODE IN ('24900','24901','24911','24950','24960','24980', '24981', '24990',
	    '24991','25000','25001','25002','25003','25010','25011','25012','25013','25020','25021','25022','25023','25030','25031','25032','25033','25040','25041',
        '25042','25043','25050','25051','25051','25052','25053','25060','25061','25062','25063','25070','25071','25072','25073','25080','25081','25082','25083',
        '25090','25091','25092','25093','2535','3572','5881','64801','64803','64804','V180') THEN 1 ELSE 0 
END) AS Diabetes,
MAX( CASE 
    WHEN DC.ICD9_CODE IN ('5718','5719','5728','570') THEN 1 ELSE 0
END) AS  Liver_diseases, 
MAX(CASE 
    WHEN DC.ICD9_CODE IN ('41020','41091','41081','41011','41032','412','41022','41002','42979','41000','41012','41181','41010','41040','41051','41001',
        '4110','41041','41082', '41092','41090','41031','41021','41042') THEN 1 ELSE 0 
END) AS Myocardial_infarction,
MAX(CASE 
    WHEN DC.ICD9_CODE IN ('41401','41412','4142') THEN 1 ELSE 0 
END) AS Coronary_artery_disease,
MAX(CASE
    WHEN DC.ICD9_CODE IN ('5712', '5715', '5716') THEN 1 ELSE 0
END) AS Cirrhosis,
MAX(CASE
    WHEN DC.ICD9_CODE = '7824' THEN 1 ELSE 0
END) AS Jaundic
INTO ISABELA.COM_DCW144
FROM ISABELA.DCW144H D24 JOIN MIMIC_UNTOUCHED.DIAGNOSES_ICD D ON  D24.HADM_ID = D.HADM_ID
 	JOIN MIMIC_UNTOUCHED.D_ICD_DIAGNOSES DC ON D.ICD9_CODE = DC.ICD9_CODE
GROUP BY D24.ICUSTAY_ID, D24.AKI_FLAG
ORDER BY D24.ICUSTAY_ID;
--1261


---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

-- DEMOGRAPHICS
DROP TABLE IF EXISTS ISABELA.DEM_DCW24;
SELECT ICUSTAY_ID, AKI_FLAG, GENDER, AGE, ETHNICITY
INTO ISABELA.DEM_DCW24
FROM  ISABELA.DCW24H 
ORDER BY ICUSTAY_ID;
--25940


DROP TABLE IF EXISTS ISABELA.DEM_DCW48;
SELECT ICUSTAY_ID, AKI_FLAG, GENDER, AGE, ETHNICITY
INTO ISABELA.DEM_DCW48
FROM  ISABELA.DCW48H 
ORDER BY ICUSTAY_ID;
--10573


DROP TABLE IF EXISTS ISABELA.DEM_DCW72;
SELECT ICUSTAY_ID, AKI_FLAG, GENDER, AGE, ETHNICITY
INTO ISABELA.DEM_DCW72
FROM  ISABELA.DCW72H 
ORDER BY ICUSTAY_ID;
--5107


DROP TABLE IF EXISTS ISABELA.DEM_DCW96;
SELECT ICUSTAY_ID, AKI_FLAG, GENDER, AGE, ETHNICITY
INTO ISABELA.DEM_DCW96
FROM  ISABELA.DCW96H 
ORDER BY ICUSTAY_ID;
--2837


DROP TABLE IF EXISTS ISABELA.DEM_DCW120;
SELECT ICUSTAY_ID, AKI_FLAG, GENDER, AGE, ETHNICITY
INTO ISABELA.DEM_DCW120
FROM  ISABELA.DCW120H 
ORDER BY ICUSTAY_ID;
--1809


DROP TABLE IF EXISTS ISABELA.DEM_DCW144;
SELECT ICUSTAY_ID, AKI_FLAG, GENDER, AGE, ETHNICITY
INTO ISABELA.DEM_DCW144
FROM  ISABELA.DCW144H 
ORDER BY ICUSTAY_ID;
--1261

---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- LABEVENTS
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

DROP TABLE IF EXISTS FEATURES_ISA.BICARBONATE_24H;
SELECT D.ICUSTAY_ID, ROUND(cast(AVG(L.VALUENUM)as NUMERIC),2) as AVG_BICARBONATE, MIN(L.VALUENUM) as MIN_BICARBONATE,
	MAX(L.VALUENUM) as MAX_BICARBONATE, COUNT(L.VALUENUM) as COUNT_BICARBONATE
INTO FEATURES_ISA.BICARBONATE_24H
FROM ISABELA.DCW24H D JOIN MIMIC_UNTOUCHED.LABEVENTS L on D.HADM_ID = L.HADM_ID
WHERE L.CHARTTIME < D.INTIME + INTERVAL '24 HOUR' AND
	L.CHARTTIME >= D.INTIME AND L.CHARTTIME <= D.OUTTIME AND    
	L.ITEMID = 50882 --BICARBONATE 
group by D.ICUSTAY_ID
order by D.ICUSTAY_ID;
--25058

DROP TABLE IF EXISTS FEATURES_ISA.BUN_24H;
SELECT D.ICUSTAY_ID, ROUND(cast(AVG(L.VALUENUM)as NUMERIC),2) as AVG_BUN, MIN(L.VALUENUM) as MIN_BUN,
	MAX(L.VALUENUM) as MAX_BUN,
	COUNT(L.VALUENUM) as COUNT_BUN
INTO FEATURES_ISA.BUN_24H
FROM ISABELA.DCW24H D JOIN MIMIC_UNTOUCHED.LABEVENTS L on D.HADM_ID = L.HADM_ID
WHERE L.CHARTTIME < D.INTIME + INTERVAL '24 HOUR' AND
	L.CHARTTIME >= D.INTIME AND L.CHARTTIME <= D.OUTTIME AND   
	L.ITEMID = 51006 --BLOOD UREA NITROGEN 
group by D.ICUSTAY_ID
order by D.ICUSTAY_ID;
--25145

DROP TABLE IF EXISTS FEATURES_ISA.CHLORIDE_24H;
SELECT D.ICUSTAY_ID, ROUND(cast(AVG(L.VALUENUM)as NUMERIC),2) as AVG_CHLORIDE, MIN(L.VALUENUM) as MIN_CHLORIDE,
	MAX(L.VALUENUM) as MAX_CHLORIDE, COUNT(L.VALUENUM) as COUNT_CHLORIDE
INTO FEATURES_ISA.CHLORIDE_24H
FROM ISABELA.DCW24H D  JOIN MIMIC_UNTOUCHED.LABEVENTS L on D.HADM_ID = L.HADM_ID
WHERE L.CHARTTIME < D.INTIME + INTERVAL '24 HOUR' AND
	L.CHARTTIME >= D.INTIME AND L.CHARTTIME <= D.OUTTIME AND  
	L.ITEMID in (50902, 50806)  -- CHLORIDE, 
group by D.ICUSTAY_ID
order by D.ICUSTAY_ID;
--25118

DROP TABLE IF EXISTS FEATURES_ISA.CREATININE_24H;
SELECT D.ICUSTAY_ID, ROUND(cast(AVG(L.VALUENUM)as NUMERIC),2) as AVG_SCR, MIN(L.VALUENUM) as MIN_SCR,
	MAX(L.VALUENUM) as MAX_SCR, COUNT(L.VALUENUM) as COUNT_SCR
INTO FEATURES_ISA.CREATININE_24H
FROM ISABELA.DCW24H D JOIN MIMIC_UNTOUCHED.LABEVENTS L on D.HADM_ID = L.HADM_ID
WHERE L.CHARTTIME < D.INTIME + INTERVAL '24 HOUR' AND
	L.CHARTTIME >= D.INTIME AND L.CHARTTIME <= D.OUTTIME AND    
	L.ITEMID = 50912 --CREATININE, 
group by D.ICUSTAY_ID
order by D.ICUSTAY_ID;
--25150

DROP TABLE IF EXISTS FEATURES_ISA.INR_24H;
SELECT D.ICUSTAY_ID, ROUND(cast(AVG(L.VALUENUM)as NUMERIC),2) as AVG_INR, MIN(L.VALUENUM) as MIN_INR,
	MAX(L.VALUENUM) as MAX_INR, COUNT(L.VALUENUM) as COUNT_INR
INTO FEATURES_ISA.INR_24H
FROM ISABELA.DCW24H D  JOIN MIMIC_UNTOUCHED.LABEVENTS L on D.HADM_ID = L.HADM_ID
WHERE L.CHARTTIME < D.INTIME + INTERVAL '24 HOUR' AND
	L.CHARTTIME >= D.INTIME AND L.CHARTTIME <= D.OUTTIME AND     
	L.ITEMID = 51237 --INTERNATIONAL NORMALIZED RATIO 
group by D.ICUSTAY_ID
order by D.ICUSTAY_ID;
--19847

DROP TABLE IF EXISTS FEATURES_ISA.PLATELETS_24H;
SELECT D.ICUSTAY_ID, ROUND(cast(AVG(L.VALUENUM)as NUMERIC),2) as AVG_PLATELETS, MIN(L.VALUENUM) as MIN_PLATELETS,
	MAX(L.VALUENUM) as MAX_PLATELETS, COUNT(L.VALUENUM) as COUNT_PLATELETS
INTO FEATURES_ISA.PLATELETS_24H
FROM ISABELA.DCW24H D  JOIN MIMIC_UNTOUCHED.LABEVENTS L on D.HADM_ID = L.HADM_ID
WHERE L.CHARTTIME < D.INTIME + INTERVAL '24 HOUR' AND
	L.CHARTTIME >= D.INTIME AND L.CHARTTIME <= D.OUTTIME AND    
	L.ITEMID = 51265 --PLATELETS
group by D.ICUSTAY_ID
order by D.ICUSTAY_ID;
--24966

DROP TABLE IF EXISTS FEATURES_ISA.POTASSIUM_24H;
SELECT D.ICUSTAY_ID, ROUND(cast(AVG(L.VALUENUM)as NUMERIC),2) as AVG_POTASSIUM, MIN(L.VALUENUM) as MIN_POTASSIUM,
	MAX(L.VALUENUM) as MAX_POTASSIUM, COUNT(L.VALUENUM) as COUNT_POTASSIUM
INTO FEATURES_ISA.POTASSIUM_24H
FROM ISABELA.DCW24H D  JOIN MIMIC_UNTOUCHED.LABEVENTS L on D.HADM_ID = L.HADM_ID
WHERE L.CHARTTIME < D.INTIME + INTERVAL '24 HOUR' AND
	L.CHARTTIME >= D.INTIME AND L.CHARTTIME <= D.OUTTIME AND    
	L.ITEMID IN (50971, 50822) --POTASSIUM 
group by D.ICUSTAY_ID
order by D.ICUSTAY_ID;
--25261

DROP TABLE IF EXISTS FEATURES_ISA.PTT_24H;
SELECT D.ICUSTAY_ID, ROUND(cast(AVG(L.VALUENUM)as NUMERIC),2) as AVG_PTT, MIN(L.VALUENUM) as MIN_PTT,
	MAX(L.VALUENUM) as MAX_PTT, COUNT(L.VALUENUM) as COUNT_PTT
INTO FEATURES_ISA.PTT_24H
FROM ISABELA.DCW24H D JOIN MIMIC_UNTOUCHED.LABEVENTS L on D.HADM_ID = L.HADM_ID
WHERE L.CHARTTIME < D.INTIME + INTERVAL '24 HOUR' AND
	L.CHARTTIME >= D.INTIME AND L.CHARTTIME <= D.OUTTIME AND  
	L.ITEMID = 51275 -- PARTIAL THROMBOBLASTIN TIME  
group by D.ICUSTAY_ID
order by D.ICUSTAY_ID;
--19730

DROP TABLE IF EXISTS FEATURES_ISA.WBC_24H;
SELECT D.ICUSTAY_ID, ROUND(cast(AVG(L.VALUENUM)as NUMERIC),2) as AVG_WBC, MIN(L.VALUENUM) as MIN_WBC,
	MAX(L.VALUENUM) as MAX_WBC,  COUNT(L.VALUENUM) as COUNT_WBC
INTO FEATURES_ISA.WBC_24H
FROM ISABELA.DCW24H D  JOIN MIMIC_UNTOUCHED.LABEVENTS L on D.HADM_ID = L.HADM_ID
WHERE L.CHARTTIME < D.INTIME + INTERVAL '24 HOUR' AND
	L.CHARTTIME >= D.INTIME AND L.CHARTTIME <= D.OUTTIME AND   
	L.ITEMID IN (51301, 51300)  --WHITE BLOOD COUNT
group by D.ICUSTAY_ID
order by D.ICUSTAY_ID;
--24905


DROP TABLE IF EXISTS FEATURES_ISA.CALCIUM_24H;
SELECT D.ICUSTAY_ID, ROUND(cast(AVG(L.VALUENUM)as NUMERIC),2) as AVG_CALCIUM, MIN(L.VALUENUM) as MIN_CALCIUM,
	MAX(L.VALUENUM) as MAX_CALCIUM, COUNT(L.VALUENUM) as COUNT_CALCIUM
INTO FEATURES_ISA.CALCIUM_24H
FROM ISABELA.DCW24H D  JOIN MIMIC_UNTOUCHED.LABEVENTS L on D.HADM_ID = L.HADM_ID
WHERE L.CHARTTIME < D.INTIME + INTERVAL '24 HOUR' AND
	L.CHARTTIME >= D.INTIME AND L.CHARTTIME <= D.OUTTIME AND     
	L.ITEMID = 50893 -- CALCIUM
group by D.ICUSTAY_ID
order by D.ICUSTAY_ID;
--21543


--48H LBEVENTS 
DROP TABLE IF EXISTS FEATURES_ISA.BICARBONATE_48H;
SELECT D.ICUSTAY_ID, ROUND(cast(AVG(L.VALUENUM)as NUMERIC),2) as AVG_BICARBONATE, MIN(L.VALUENUM) as MIN_BICARBONATE,
	MAX(L.VALUENUM) as MAX_BICARBONATE, COUNT(L.VALUENUM) as COUNT_BICARBONATE
INTO FEATURES_ISA.BICARBONATE_48H
FROM ISABELA.DCW48H D JOIN MIMIC_UNTOUCHED.LABEVENTS L on D.HADM_ID = L.HADM_ID
WHERE L.CHARTTIME < D.INTIME + INTERVAL '48 HOUR' AND
	L.CHARTTIME >= D.INTIME AND L.CHARTTIME <= D.OUTTIME AND    
	L.ITEMID = 50882 --BICARBONATE 
group by D.ICUSTAY_ID
order by D.ICUSTAY_ID;


DROP TABLE IF EXISTS FEATURES_ISA.BUN_48H;
SELECT D.ICUSTAY_ID, ROUND(cast(AVG(L.VALUENUM)as NUMERIC),2) as AVG_BUN, MIN(L.VALUENUM) as MIN_BUN,
	MAX(L.VALUENUM) as MAX_BUN,
	COUNT(L.VALUENUM) as COUNT_BUN
INTO FEATURES_ISA.BUN_48H
FROM ISABELA.DCW48H D JOIN MIMIC_UNTOUCHED.LABEVENTS L on D.HADM_ID = L.HADM_ID
WHERE L.CHARTTIME < D.INTIME + INTERVAL '48 HOUR' AND
	L.CHARTTIME >= D.INTIME AND L.CHARTTIME <= D.OUTTIME AND  
	L.ITEMID = 51006 --BLOOD UREA NITROGEN 
group by D.ICUSTAY_ID
order by D.ICUSTAY_ID;


DROP TABLE IF EXISTS FEATURES_ISA.CHLORIDE_48H;
SELECT D.ICUSTAY_ID, ROUND(cast(AVG(L.VALUENUM)as NUMERIC),2) as AVG_CHLORIDE, MIN(L.VALUENUM) as MIN_CHLORIDE,
	MAX(L.VALUENUM) as MAX_CHLORIDE, COUNT(L.VALUENUM) as COUNT_CHLORIDE
INTO FEATURES_ISA.CHLORIDE_48H
FROM ISABELA.DCW48H D  JOIN MIMIC_UNTOUCHED.LABEVENTS L on D.HADM_ID = L.HADM_ID
WHERE L.CHARTTIME < D.INTIME + INTERVAL '48 HOUR' AND
	L.CHARTTIME >= D.INTIME AND L.CHARTTIME <= D.OUTTIME AND   
	L.ITEMID in (50902, 50806)  -- CHLORIDE, 
group by D.ICUSTAY_ID
order by D.ICUSTAY_ID;
-

DROP TABLE IF EXISTS FEATURES_ISA.CREATININE_48H;
SELECT D.ICUSTAY_ID, ROUND(cast(AVG(L.VALUENUM)as NUMERIC),2) as AVG_SCR, MIN(L.VALUENUM) as MIN_SCR,
	MAX(L.VALUENUM) as MAX_SCR, COUNT(L.VALUENUM) as COUNT_SCR
INTO FEATURES_ISA.CREATININE_48H
FROM ISABELA.DCW48H D JOIN MIMIC_UNTOUCHED.LABEVENTS L on D.HADM_ID = L.HADM_ID
WHERE L.CHARTTIME < D.INTIME + INTERVAL '48 HOUR' AND
	L.CHARTTIME >= D.INTIME AND L.CHARTTIME <= D.OUTTIME AND    
	L.ITEMID = 50912 --CREATININE, 
group by D.ICUSTAY_ID
order by D.ICUSTAY_ID;


DROP TABLE IF EXISTS FEATURES_ISA.INR_48H;
SELECT D.ICUSTAY_ID, ROUND(cast(AVG(L.VALUENUM)as NUMERIC),2) as AVG_INR, MIN(L.VALUENUM) as MIN_INR,
	MAX(L.VALUENUM) as MAX_INR, COUNT(L.VALUENUM) as COUNT_INR
INTO FEATURES_ISA.INR_48H
FROM ISABELA.DCW48H D  JOIN MIMIC_UNTOUCHED.LABEVENTS L on D.HADM_ID = L.HADM_ID
WHERE L.CHARTTIME < D.INTIME + INTERVAL '48 HOUR' AND
	L.CHARTTIME >= D.INTIME AND L.CHARTTIME <= D.OUTTIME AND  
	L.ITEMID = 51237 --INTERNATIONAL NORMALIZED RATIO 
group by D.ICUSTAY_ID
order by D.ICUSTAY_ID;


DROP TABLE IF EXISTS FEATURES_ISA.PLATELETS_48H;
SELECT D.ICUSTAY_ID, ROUND(cast(AVG(L.VALUENUM)as NUMERIC),2) as AVG_PLATELETS, MIN(L.VALUENUM) as MIN_PLATELETS,
	MAX(L.VALUENUM) as MAX_PLATELETS, COUNT(L.VALUENUM) as COUNT_PLATELETS
INTO FEATURES_ISA.PLATELETS_48H
FROM ISABELA.DCW48H D  JOIN MIMIC_UNTOUCHED.LABEVENTS L on D.HADM_ID = L.HADM_ID
WHERE L.CHARTTIME < D.INTIME + INTERVAL '48 HOUR' AND
	L.CHARTTIME >= D.INTIME AND L.CHARTTIME <= D.OUTTIME AND  
	L.ITEMID = 51265 --PLATELETS
group by D.ICUSTAY_ID
order by D.ICUSTAY_ID;

DROP TABLE IF EXISTS FEATURES_ISA.POTASSIUM_48H;
SELECT D.ICUSTAY_ID, ROUND(cast(AVG(L.VALUENUM)as NUMERIC),2) as AVG_POTASSIUM, MIN(L.VALUENUM) as MIN_POTASSIUM,
	MAX(L.VALUENUM) as MAX_POTASSIUM, COUNT(L.VALUENUM) as COUNT_POTASSIUM
INTO FEATURES_ISA.POTASSIUM_48H
FROM ISABELA.DCW48H D  JOIN MIMIC_UNTOUCHED.LABEVENTS L on D.HADM_ID = L.HADM_ID
WHERE L.CHARTTIME < D.INTIME + INTERVAL '48 HOUR' AND
	L.CHARTTIME >= D.INTIME AND L.CHARTTIME <= D.OUTTIME AND   
	L.ITEMID IN (50971, 50822) --POTASSIUM 
group by D.ICUSTAY_ID
order by D.ICUSTAY_ID;

DROP TABLE IF EXISTS FEATURES_ISA.PTT_48H;
SELECT D.ICUSTAY_ID, ROUND(cast(AVG(L.VALUENUM)as NUMERIC),2) as AVG_PTT, MIN(L.VALUENUM) as MIN_PTT,
	MAX(L.VALUENUM) as MAX_PTT, COUNT(L.VALUENUM) as COUNT_PTT
INTO FEATURES_ISA.PTT_48H
FROM ISABELA.DCW48H D JOIN MIMIC_UNTOUCHED.LABEVENTS L on D.HADM_ID = L.HADM_ID
WHERE L.CHARTTIME < D.INTIME + INTERVAL '48 HOUR' AND
	L.CHARTTIME >= D.INTIME AND L.CHARTTIME <= D.OUTTIME AND  
	L.ITEMID = 51275 -- PARTIAL THROMBOBLASTIN TIME  
group by D.ICUSTAY_ID
order by D.ICUSTAY_ID;

DROP TABLE IF EXISTS FEATURES_ISA.WBC_48H;
SELECT D.ICUSTAY_ID, ROUND(cast(AVG(L.VALUENUM)as NUMERIC),2) as AVG_WBC, MIN(L.VALUENUM) as MIN_WBC,
	MAX(L.VALUENUM) as MAX_WBC,  COUNT(L.VALUENUM) as COUNT_WBC
INTO FEATURES_ISA.WBC_48H
FROM ISABELA.DCW48H D  JOIN MIMIC_UNTOUCHED.LABEVENTS L on D.HADM_ID = L.HADM_ID
WHERE L.CHARTTIME < D.INTIME + INTERVAL '48 HOUR' AND
	L.CHARTTIME >= D.INTIME AND L.CHARTTIME <= D.OUTTIME AND    
	L.ITEMID IN (51301, 51300)  --WHITE BLOOD COUNT
group by D.ICUSTAY_ID
order by D.ICUSTAY_ID;


DROP TABLE IF EXISTS FEATURES_ISA.CALCIUM_48H;
SELECT D.ICUSTAY_ID, ROUND(cast(AVG(L.VALUENUM)as NUMERIC),2) as AVG_CALCIUM, MIN(L.VALUENUM) as MIN_CALCIUM,
	MAX(L.VALUENUM) as MAX_CALCIUM, COUNT(L.VALUENUM) as COUNT_CALCIUM
INTO FEATURES_ISA.CALCIUM_48H
FROM ISABELA.DCW48H D  JOIN MIMIC_UNTOUCHED.LABEVENTS L on D.HADM_ID = L.HADM_ID
WHERE L.CHARTTIME < D.INTIME + INTERVAL '48 HOUR' AND
	L.CHARTTIME >= D.INTIME AND L.CHARTTIME <= D.OUTTIME AND     
	L.ITEMID = 50893 -- CALCIUM
group by D.ICUSTAY_ID
order by D.ICUSTAY_ID;



---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- URINE 
drop table if exists FEATURES_ISA.URINES_DCW24;
SELECT F.ICUSTAY_ID, ROUND(cast(AVG(O.VALUE)as NUMERIC),2) as AVG_URINE, MIN(O.VALUE) as MIN_URINE,
	MAX(O.VALUE) as MAX_URINE, COUNT(O.VALUE) as COUNT_URINE
INTO FEATURES_ISA.URINES_DCW24
FROM isabela.DCW24H F JOIN MIMIC_UNTOUCHED.OUTPUTEVENTS O on F.ICUSTAY_ID = O.ICUSTAY_ID --MODIFICATO
WHERE O.CHARTTIME < F.INTIME + INTERVAL '24 HOUR' and 
	O.CHARTTIME >= F.INTIME AND O.CHARTTIME <= F.OUTTIME AND  --MODIFICATO  
	O.ITEMID IN ( 40055,43175,40069,40094,40715,40473,40085,40057,40056,
				   40405,40428,40086,40096,40651,226559,226560,226561,226584,
				   226563,226564,226565,226567,226557,226558,227488,227489)
group by F.ICUSTAY_ID
order by F.ICUSTAY_ID;
--23914


---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- CHARTEVENTS
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
DROP TABLE IF EXISTS FEATURES_ISA.HEART_RATE_24H;
SELECT F.ICUSTAY_ID, ROUND(cast(AVG(C.VALUENUM)as NUMERIC),2) as AVG_HEART_RATE, MIN(C.VALUENUM) as MIN_HEART_RATE,
	MAX(C.VALUENUM) as MAX_HEART_RATE, COUNT(C.VALUENUM) as COUNT_HEART_RATE
INTO FEATURES_ISA.HEART_RATE_24H
FROM ISABELA.DCW24H F  JOIN MIMIC_UNTOUCHED.CHARTEVENTS C on F.ICUSTAY_ID = C.ICUSTAY_ID
WHERE C.CHARTTIME < F.INTIME + INTERVAL '24 HOUR' AND
	C.CHARTTIME >= F.INTIME AND C.CHARTTIME <= F.OUTTIME AND  
	C.ITEMID IN (211, 220045) --HEART RATE
group by F.ICUSTAY_ID
order by F.ICUSTAY_ID;
--25322

DROP TABLE IF EXISTS FEATURES_ISA.SYSBP_24H;
SELECT F.ICUSTAY_ID, ROUND(cast(AVG(C.VALUENUM)as NUMERIC),2) as AVG_SYSBP, MIN(C.VALUENUM) as MIN_SYSBP,
	MAX(C.VALUENUM) as MAX_SYSBP, COUNT(C.VALUENUM) as COUNT_SYSBP
INTO FEATURES_ISA.SYSBP_24H
FROM ISABELA.DCW24H F JOIN MIMIC_UNTOUCHED.CHARTEVENTS C on F.ICUSTAY_ID = C.ICUSTAY_ID
WHERE C.CHARTTIME < F.INTIME + INTERVAL '24 HOUR' AND
	C.CHARTTIME >= F.INTIME AND C.CHARTTIME <= F.OUTTIME AND   
	C.ITEMID IN ( 51, 442, 455, 6701, 220179,  220050) --SYSTOLIC BLOOD PRESSURE
group by F.ICUSTAY_ID
order by F.ICUSTAY_ID;
--25311

DROP TABLE IF EXISTS FEATURES_ISA.DIASBP_24H;
SELECT F.ICUSTAY_ID, ROUND(cast(AVG(C.VALUENUM)as NUMERIC),2) as AVG_DIASBP, MIN(C.VALUENUM) as MIN_DIASBP,
	MAX(C.VALUENUM) as MAX_DIASBP, COUNT(C.VALUENUM) as COUNT_DIASBP
INTO FEATURES_ISA.DIASBP_24H
FROM ISABELA.DCW24H F  JOIN MIMIC_UNTOUCHED.CHARTEVENTS C on F.ICUSTAY_ID = C.ICUSTAY_ID
WHERE C.CHARTTIME < F.INTIME + INTERVAL '24 HOUR' AND
	C.CHARTTIME >= F.INTIME AND C.CHARTTIME <= F.OUTTIME AND   
	C.ITEMID IN ( 8368, 8440, 8441, 8555, 220180, 220051) --DIASTOLIC BLOOD PRESSURE
group by F.ICUSTAY_ID
order by F.ICUSTAY_ID;
--25307

DROP TABLE IF EXISTS FEATURES_ISA.MEANBP_24H;
SELECT F.ICUSTAY_ID, ROUND(cast(AVG(C.VALUENUM)as NUMERIC),2) as AVG_MEANBP, MIN(C.VALUENUM) as MIN_MEANBP,
	MAX(C.VALUENUM) as MAX_MEANBP, COUNT(C.VALUENUM) as COUNT_MEANBP
INTO FEATURES_ISA.MEANBP_24H
FROM ISABELA.DCW24H F JOIN MIMIC_UNTOUCHED.CHARTEVENTS C on F.ICUSTAY_ID = C.ICUSTAY_ID
WHERE C.CHARTTIME < F.INTIME + INTERVAL '24 HOUR' AND
	C.CHARTTIME >= F.INTIME AND C.CHARTTIME <= F.OUTTIME AND  
	C.ITEMID IN ( 456, 52, 6702, 443, 220052, 220181, 225312) --MEAN ARTERIAL BLOOD PRESSURE
group by F.ICUSTAY_ID
order by F.ICUSTAY_ID;
--25321

DROP TABLE IF EXISTS FEATURES_ISA.RESPRATE_24H;
SELECT F.ICUSTAY_ID, ROUND(cast(AVG(C.VALUENUM)as NUMERIC),2) as AVG_RESP, MIN(C.VALUENUM) as MIN_RESP,
	MAX(C.VALUENUM) as MAX_RESP, COUNT(C.VALUENUM) as COUNT_RESP
INTO FEATURES_ISA.RESPRATE_24H
FROM ISABELA.DCW24H F JOIN MIMIC_UNTOUCHED.CHARTEVENTS C on F.ICUSTAY_ID = C.ICUSTAY_ID
WHERE C.CHARTTIME < F.INTIME + INTERVAL '24 HOUR' AND
	C.CHARTTIME >= F.INTIME AND C.CHARTTIME <= F.OUTTIME AND     
	C.ITEMID IN ( 618, 615, 220210, 224690) --RESPIRATION RATE 
group by F.ICUSTAY_ID
order by F.ICUSTAY_ID;
--25293

DROP TABLE IF EXISTS FEATURES_ISA.TEMP_24H;
SELECT F.ICUSTAY_ID, ROUND(cast(AVG(C.VALUENUM)as NUMERIC),2) as AVG_TEMP, MIN(C.VALUENUM) as MIN_TEMP,
	MAX(C.VALUENUM) as MAX_TEMP, COUNT(C.VALUENUM) as COUNT_TEMP
INTO FEATURES_ISA.TEMP_24H
FROM ISABELA.DCW24H F  JOIN MIMIC_UNTOUCHED.CHARTEVENTS C on F.ICUSTAY_ID = C.ICUSTAY_ID
WHERE C.CHARTTIME < F.INTIME + INTERVAL '24 HOUR' AND
	C.CHARTTIME >= F.INTIME AND C.CHARTTIME <= F.OUTTIME AND 
	C.ITEMID IN ( 223762, 676, 223761, 678) --TEMPERATURE  
group by F.ICUSTAY_ID
order by F.ICUSTAY_ID;
--25015

DROP TABLE IF EXISTS FEATURES_ISA.SPO2_24H;
SELECT F.ICUSTAY_ID, ROUND(cast(AVG(C.VALUENUM)as NUMERIC),2) as AVG_SPO2, MIN(C.VALUENUM) as MIN_SPO2,
	MAX(C.VALUENUM) as MAX_SPO2, COUNT(C.VALUENUM) as COUNT_SPO2
INTO FEATURES_ISA.SPO2_24H
FROM ISABELA.DCW24H F JOIN MIMIC_UNTOUCHED.CHARTEVENTS C on F.ICUSTAY_ID = C.ICUSTAY_ID
WHERE C.CHARTTIME < F.INTIME + INTERVAL '24 HOUR' AND
	C.CHARTTIME >= F.INTIME AND C.CHARTTIME <= F.OUTTIME AND     
	C.ITEMID IN ( 646, 220277) --SPO2  
group by F.ICUSTAY_ID
order by F.ICUSTAY_ID;
--25314

DROP TABLE IF EXISTS FEATURES_ISA.GLUCOSE_24H;
SELECT F.ICUSTAY_ID, ROUND(cast(AVG(C.VALUENUM)as NUMERIC),2) as AVG_GLUCOSE, MIN(C.VALUENUM) as MIN_GLUCOSE,
	MAX(C.VALUENUM) as MAX_GLUCOSE,COUNT(C.VALUENUM) as COUNT_GLUCOSE
INTO FEATURES_ISA.GLUCOSE_24H
FROM ISABELA.DCW24H F  JOIN MIMIC_UNTOUCHED.CHARTEVENTS C on F.ICUSTAY_ID = C.ICUSTAY_ID
WHERE C.CHARTTIME < F.INTIME + INTERVAL '24 HOUR' AND
	C.CHARTTIME >= F.INTIME AND C.CHARTTIME <= F.OUTTIME AND     
	C.ITEMID IN ( 807, 811, 1529, 3745,  3744, 225664, 220621, 226537) --GLUCOSE 
group by F.ICUSTAY_ID
order by F.ICUSTAY_ID;
--25122

---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- NOW PUT TOGETHER
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

DROP TABLE IF EXISTS FEATURES_ISA.ALL_LABDCW24;
SELECT W.ICUSTAY_ID, W.AKI_FLAG, BIC.AVG_BICARBONATE, BIC.MIN_BICARBONATE,BIC.MAX_BICARBONATE,BIC.COUNT_BICARBONATE,
 B.AVG_BUN, B.MIN_BUN,B.MAX_BUN,B.COUNT_BUN, CH.AVG_CHLORIDE, CH.MIN_CHLORIDE,CH.MAX_CHLORIDE,CH.COUNT_CHLORIDE,
 SCR.AVG_SCR, SCR.MIN_SCR,SCR.MAX_SCR,SCR.COUNT_SCR, I.AVG_INR, I.MIN_INR,I.MAX_INR,I.COUNT_INR, 
 PL.AVG_PLATELETS, PL.MIN_PLATELETS,PL.MAX_PLATELETS,PL.COUNT_PLATELETS,
 POT.AVG_POTASSIUM, POT.MIN_POTASSIUM,POT.MAX_POTASSIUM,POT.COUNT_POTASSIUM, 
 PTT.AVG_PTT, PTT.MIN_PTT,PTT.MAX_PTT,PTT.COUNT_PTT,WBC.AVG_WBC, WBC.MIN_WBC,WBC.MAX_WBC,WBC.COUNT_WBC, C.AVG_CALCIUM,
 C.MIN_CALCIUM,C.MAX_CALCIUM,C.COUNT_CALCIUM
INTO FEATURES_ISA.ALL_LABDCW24
FROM FEATURES_ISA.BUN_24H B JOIN FEATURES_ISA.BICARBONATE_24H BIC on B.ICUSTAY_ID = BIC.ICUSTAY_ID
	JOIN FEATURES_ISA.CHLORIDE_24H CH ON B.ICUSTAY_ID = CH.ICUSTAY_ID
	JOIN FEATURES_ISA.CREATININE_24H SCR ON B.ICUSTAY_ID = SCR.ICUSTAY_ID
	JOIN FEATURES_ISA.INR_24H I ON SCR.ICUSTAY_ID = I.ICUSTAY_ID
	JOIN FEATURES_ISA.PLATELETS_24H PL ON I.ICUSTAY_ID = PL.ICUSTAY_ID
	JOIN FEATURES_ISA.POTASSIUM_24H POT ON B.ICUSTAY_ID = POT.ICUSTAY_ID
	JOIN FEATURES_ISA.PTT_24H PTT ON POT.ICUSTAY_ID = PTT.ICUSTAY_ID
	JOIN FEATURES_ISA.WBC_24H WBC ON POT.ICUSTAY_ID = WBC.ICUSTAY_ID
	JOIN FEATURES_ISA.CALCIUM_24H C ON POT.ICUSTAY_ID = C.ICUSTAY_ID
	JOIN ISABELA.DCW24H W ON C.ICUSTAY_ID = W.ICUSTAY_ID
ORDER BY  W.ICUSTAY_ID;
--16479

-- CHECK FOR RANDOM MIN VALUES
SELECT * FROM FEATURES_ISA.ALL_LABDCW24
WHERE MIN_BICARBONATE IS NULL;
--3 

SELECT * FROM FEATURES_ISA.ALL_LABDCW24
WHERE MIN_INR IS NULL;
--2 

SELECT * FROM FEATURES_ISA.ALL_LABDCW24
WHERE MIN_POTASSIUM IS NULL;
--1 

SELECT * FROM FEATURES_ISA.ALL_LABDCW24
WHERE MIN_PTT IS NULL;
--4

--ALL THE OTHER FEATURES HAS NOT MISSING VALUES. 


--PUT TOGETHER NOW THE LABS WITH THE PATIENTS
SELECT D.ICUSTAY_ID, D.AKI_FLAG, L.AVG_BICARBONATE, L.MIN_BICARBONATE,L.MAX_BICARBONATE,L.COUNT_BICARBONATE,
 L.AVG_BUN, L.MIN_BUN,L.MAX_BUN, L.COUNT_BUN, L.AVG_CHLORIDE, L.MIN_CHLORIDE,L.MAX_CHLORIDE,L.COUNT_CHLORIDE,
 L.AVG_SCR, L.MIN_SCR, L.MAX_SCR, L.COUNT_SCR, L.AVG_INR, L.MIN_INR,L.MAX_INR,L.COUNT_INR, 
 L.AVG_PLATELETS, L.MIN_PLATELETS, L.MAX_PLATELETS, L.COUNT_PLATELETS,
 L.AVG_POTASSIUM, L.MIN_POTASSIUM, L.MAX_POTASSIUM, L.COUNT_POTASSIUM, 
 L.AVG_PTT, L.MIN_PTT, L.MAX_PTT, L.COUNT_PTT, L.AVG_WBC, L.MIN_WBC, L.MAX_WBC, L.COUNT_WBC, L.AVG_CALCIUM
 L.MIN_CALCIUM, L.MAX_CALCIUM, L.COUNT_CALCIUM
INTO ISABELA.LAB_DCW24
FROM FEATURES_ISA.ALL_LABDCW24 L JOIN ISABELA.DCW24H D ON L.ICUSTAY_ID = D.ICUSTAY_ID
ORDER BY D.ICUSTAY_ID;
--16479
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


DROP TABLE IF EXISTS FEATURES_ISA.ALL_CHARTDCW24;
SELECT W.ICUSTAY_ID, W.AKI_FLAG, MBP.AVG_MEANBP, MBP.MIN_MEANBP,MBP.MAX_MEANBP,MBP.COUNT_MEANBP,
 HR.AVG_HEART_RATE, HR.MIN_HEART_RATE,HR.MAX_HEART_RATE,HR.COUNT_HEART_RATE, SBP.AVG_SYSBP, SBP.MIN_SYSBP,SBP.MAX_SYSBP,SBP.COUNT_SYSBP,
 DBP.AVG_DIASBP,DBP.MIN_DIASBP,DBP.MAX_DIASBP,DBP.COUNT_DIASBP, R.AVG_RESP, R.MIN_RESP,R.MAX_RESP,R.COUNT_RESP, 
 T.AVG_TEMP, T.MIN_TEMP,T.MAX_TEMP,T.COUNT_TEMP,
 SP.AVG_SPO2, SP.MIN_SPO2,SP.MAX_SPO2,SP.COUNT_SPO2, 
 G.AVG_GLUCOSE, G.MIN_GLUCOSE,G.MAX_GLUCOSE,G.COUNT_GLUCOSE
INTO FEATURES_ISA.ALL_CHARTDCW24
FROM  FEATURES_ISA.MEANBP_24H MBP JOIN FEATURES_ISA.HEART_RATE_24H HR on MBP.ICUSTAY_ID = HR.ICUSTAY_ID
	JOIN FEATURES_ISA.SYSBP_24H SBP ON MBP.ICUSTAY_ID = SBP.ICUSTAY_ID
	JOIN FEATURES_ISA.DIASBP_24H DBP ON MBP.ICUSTAY_ID = DBP.ICUSTAY_ID
	JOIN FEATURES_ISA.RESPRATE_24H R ON MBP.ICUSTAY_ID = R.ICUSTAY_ID
	JOIN FEATURES_ISA.TEMP_24H T ON MBP.ICUSTAY_ID = T.ICUSTAY_ID
	JOIN FEATURES_ISA.SPO2_24H SP ON MBP.ICUSTAY_ID = SP.ICUSTAY_ID
	JOIN FEATURES_ISA.GLUCOSE_24H G ON MBP.ICUSTAY_ID = G.ICUSTAY_ID
	JOIN ISABELA.DCW24H W ON G.ICUSTAY_ID = W.ICUSTAY_ID
ORDER BY W.ICUSTAY_ID;
--24702

-- CHECK FOR RANDOM MIN VALUES
SELECT * FROM FEATURES_ISA.ALL_CHARTDCW24
WHERE MIN_SPO2 IS NULL;
--1

SELECT * FROM FEATURES_ISA.ALL_CHARTDCW24
WHERE MIN_GLUCOSE IS NULL;
--3

-- ALL THE OTHER HAS NOT MISSING VALUES.


-- CREATE THE TABLE ON WHICHI THE PREDICTION SHOULD BE EPERFORMED: DCW24H JOIN ALL_CHARTDCW24
SELECT D.ICUSTAY_ID, D.AKI_FLAG, C.AVG_MEANBP, C.MIN_MEANBP, C.MAX_MEANBP, C.COUNT_MEANBP,
 C.AVG_HEART_RATE, C.MIN_HEART_RATE, C.MAX_HEART_RATE, C.COUNT_HEART_RATE, C.AVG_SYSBP, C.MIN_SYSBP, C.MAX_SYSBP, C.COUNT_SYSBP,
 C.AVG_DIASBP, C.MIN_DIASBP, C.MAX_DIASBP, C.COUNT_DIASBP, C.AVG_RESP, C.MIN_RESP, C.MAX_RESP, C.COUNT_RESP, 
 C.AVG_TEMP, C.MIN_TEMP, C.MAX_TEMP, C.COUNT_TEMP,
 C.AVG_SPO2, C.MIN_SPO2, C.MAX_SPO2, C.COUNT_SPO2, 
 C.AVG_GLUCOSE, C.MIN_GLUCOSE, C.MAX_GLUCOSE, C.COUNT_GLUCOSE
INTO ISABELA.CHART_DCW24
FROM FEATURES_ISA.ALL_CHARTDCW24 C JOIN ISABELA.DCW24H D ON C.ICUSTAY_ID = D.ICUSTAY_ID
ORDER BY D.ICUSTAY_ID;
--24702



-------------------------------------------------------------------------------------------------------------------------------------------
--BEST FEATURES AFTER CROSS VALIDATION 5-FOLD 
SELECT D.ICUSTAY_ID, D.AKI_FLAG, D.AGE, D.GENDER, M.DIURETICS, C.CONGESTIVE_HEART_FAILURE, C.DIABETES, C.HYPERTENSION,
	L.AVG_BICARBONATE, L.MIN_BICARBONATE,L.MAX_BICARBONATE, L.AVG_BUN, L.MIN_BUN,L.MAX_BUN, L.AVG_CHLORIDE, L.MIN_CHLORIDE,L.MAX_CHLORIDE,
 L.AVG_SCR, L.MIN_SCR, L.MAX_SCR, L.AVG_INR, L.MIN_INR,L.MAX_INR, L.AVG_PLATELETS, L.MIN_PLATELETS, L.MAX_PLATELETS, 
 L.AVG_POTASSIUM, L.MIN_POTASSIUM, L.MAX_POTASSIUM, L.AVG_PTT, L.MIN_PTT, L.MAX_PTT, L.AVG_WBC, L.MIN_WBC, L.MAX_WBC, L.AVG_CALCIUM,
 L.MIN_CALCIUM, L.MAX_CALCIUM, CH.AVG_MEANBP, CH.MIN_MEANBP, CH.MAX_MEANBP, CH.AVG_HEART_RATE, CH.MIN_HEART_RATE, CH.MAX_HEART_RATE,
 CH.AVG_SYSBP, CH.MIN_SYSBP, CH.MAX_SYSBP, CH.AVG_DIASBP, CH.MIN_DIASBP, CH.MAX_DIASBP, CH.AVG_RESP, CH.MIN_RESP, CH.MAX_RESP,CH.AVG_TEMP, 
 CH.MIN_TEMP, CH.MAX_TEMP, CH.AVG_SPO2, CH.MIN_SPO2, CH.MAX_SPO2, CH.AVG_GLUCOSE, CH.MIN_GLUCOSE, CH.MAX_GLUCOSE
INTO PREDICTION_ISA.BESTFEATURES24
FROM PREDICTION_ISA.DEM24 D JOIN PREDICTION_ISA.MED24 M ON D.ICUSTAY_ID = M.ICUSTAY_ID
	JOIN PREDICTION_ISA.COM24 C ON M.ICUSTAY_ID = C.ICUSTAY_ID
	JOIN PREDICTION_ISA.LAB24 L ON C.ICUSTAY_ID = L.ICUSTAY_ID
	JOIN PREDICTION_ISA.CHART24 CH ON L.ICUSTAY_ID = CH.ICUSTAY_ID;
--15282



